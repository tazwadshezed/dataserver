/*
 Copyright 2012 Draker Inc - Pats Pending
*/
define(["jquery","highcharts","static/_build/scripts/modules/urls","utils"],function(g, m){ss.charts={template:function(a){return['<div id="'+a.id+'" class="module interactive chart dynamic '+(a.addClass||"")+'">','<div class="title"><h3>Loading...</h3></div><div class="content">','<img src='+ss.urls.src+'"../../../images/icon_loading.gif" class="loading">',"</div></div>"].join("")},_chartOptions:function(){var a={allowPointSelect:!0,chart:{animation:!1,type:"spline",spacingTop:12,spacingRight:12,spacingBottom:12,spacingLeft:12,zoomType:"xy",
plotBorderWidth:1,plotBorderColor:"#ccc",resetZoomButton:{theme:{border:"1px solid #f00",background:"#545454 url(../images/sprite_btns.png) 0 -300px repeat-x"},position:{}}},credits:!1,navigation:{buttonOptions:{align:"left"}},plotOptions:{area:{animation:!1,fillOpacity:0,lineWidth:0,marker:{enabled:!1,radius:2,states:{hover:{enabled:!0,radius:3}}},stacking:"normal",shadow:!1},line:{animation:!1,lineWidth:2,marker:{enabled:!1,radius:2,states:{hover:{enabled:!0,radius:3}}},states:{hover:{lineWidth:2}},
shadow:!1},spline:{animation:!1,lineWidth:2,marker:{enabled:!1,radius:3,states:{hover:{enabled:!0,radius:3}}},states:{hover:{lineWidth:2}},shadow:!1}},title:{text:null},tooltip:{enabled:!0,crosshairs:!0,shared:!0,borderColor:"#cccccc",borderRadius:2,borderWidth:1,shadow:!1,useHTML:!0,xDateFormat:"%Y-%m-%d %H:%M",headerFormat:'<span style="color:#555;font-size:1.25em;">{point.key}</span><br>'}},d=g.extend(!0,{},a,{legend:{enabled:!1},xAxis:[{min:0,title:{text:"",style:{fontFamily:"Arial, Helvetica, sans-serif",
fontWeight:"normal",color:"#555"}}}],yAxis:[{min:0,title:{text:"",style:{fontFamily:"Arial, Helvetica, sans-serif",fontWeight:"normal",color:"#555"}}}]}),c=g.extend(!0,{},a,{chart:{animation:!1,spacingTop:0,spacingRight:0,spacingBottom:1,spacingLeft:0,zoomType:!1,borderWidth:0,backgroundColor:!1,plotBorderWidth:0,plotBackgroundColor:!1},tooltip:!1,legend:!1,plotOptions:{series:{marker:{enabled:!1}}},xAxis:[{title:!1,type:"datetime",labels:!1,lineWidth:0}],yAxis:[{min:0,title:!1,labels:!1,gridLineWidth:0}]}),
b=g.extend(!0,{},a,{chart:{events:{click:function(a){g(document).trigger("setTime",{time:a.xAxis[0].value})}}},legend:{layout:"vertical",verticalAlign:"bottom",align:"left",borderRadius:2,borderWidth:1,borderColor:"#ccc",floating:!0,backgroundColor:"#fff",x:60,y:-24,itemStyle:{color:"#06c",textDecoration:"none"},itemHoverStyle:{color:"#06c",textDecoration:"underline"},labelFormatter:function(){return this.name}},xAxis:{type:"datetime",dateTimeLabelFormats:{hour:"%H:%M"}},yAxis:[{min:0,title:{text:"",
style:{fontFamily:"Arial, Helvetica, sans-serif",fontWeight:"normal",color:"#555"}}},{min:0,opposite:!0,title:{text:"",style:{fontFamily:"Arial, Helvetica, sans-serif",fontWeight:"normal",color:"#555"}}},{min:0,opposite:!1,labels:{formatter:function(){return""}},title:{text:"",style:{fontFamily:"Arial, Helvetica, sans-serif",fontWeight:"normal",color:"#555"}}},{min:0,opposite:!1,labels:{formatter:function(){return""}},title:{text:"",style:{fontFamily:"Arial, Helvetica, sans-serif",fontWeight:"normal",
color:"#555"}}},{gridLineWidth:0,tickWidth:0,showLastLabel:!1,labels:{enabled:!1},title:{text:""},min:0,max:1,minPadding:0,maxPadding:0}]}),a=g.extend(!0,{},a,{credits:!1,chart:{type:"spline",spacingTop:12,spacingRight:12,spacingBottom:12,spacingLeft:12,zoomType:null,plotBorderWidth:1,plotBorderColor:"#222",backgroundColor:"#333",resetZoomButton:{theme:{border:"1px solid #f00",background:"#545454 url(../_images/sprite_btns.png) 0 -300px repeat-x"},position:{}}},allowPointSelect:!0,legend:{layout:"vertical",
verticalAlign:"bottom",align:"left",borderRadius:2,borderWidth:1,borderColor:"#222",floating:!0,backgroundColor:"#555",x:60,y:-24,itemStyle:{color:"#ccc",textDecoration:"none"},itemHoverStyle:{color:"#ccc",textDecoration:"underline"},labelFormatter:function(){return this.name}},plotOptions:{line:{lineWidth:2,marker:{enabled:!0,radius:2,states:{hover:{enabled:!0,radius:4}}}},spline:{lineWidth:2,marker:{enabled:!1,radius:0,states:{hover:{enabled:!1,radius:5}}}},area:{fillOpacity:0.5,lineWidth:2,marker:{enabled:!0,
radius:3,states:{hover:{enabled:!0,radius:5}}},stacking:"normal",shadow:!1}},title:{text:null},xAxis:{type:"datetime",dateTimeLabelFormats:{hour:"%H:%M"},gridLineColor:"#222",tickColor:"#222",lineColor:"#333",labels:{style:{color:"#ccc"}}},yAxis:[{min:0,gridLineColor:"#222",tickColor:"#222",title:{text:"",style:{fontFamily:"Arial, Helvetica, sans-serif",fontWeight:"normal",color:"#ccc"}},labels:{style:{color:"#ccc"}}},{min:0,opposite:!0,gridLineColor:"#222",tickColor:"#222",title:{text:"",style:{fontFamily:"Arial, Helvetica, sans-serif",
fontWeight:"normal",color:"#ccc"}},labels:{style:{color:"#ccc"}}},{min:0,opposite:!1,labels:{formatter:function(){return""}},title:{text:"",style:{fontFamily:"Arial, Helvetica, sans-serif",fontWeight:"normal",color:"#ccc"}},labels:{style:{color:"#ccc"}}},{min:0,opposite:!1,labels:{formatter:function(){return""}},title:{text:"",style:{fontFamily:"Arial, Helvetica, sans-serif",fontWeight:"normal",color:"#ccc"}},labels:{style:{color:"#ccc"}}},{labels:{formatter:function(){return""}},title:{text:"",style:{fontFamily:"Arial, Helvetica, sans-serif",
fontWeight:"normal",color:"#ccc"}},min:0,max:1,minPadding:0,maxPadding:0}],tooltip:{enabled:!1,crosshairs:!0,shared:!0,borderColor:"#cccccc",borderRadius:2,borderWidth:1,useHTML:!0,xDateFormat:"%e %b %H:%M",headerFormat:'<span style="color:#555;font-size:1.25em;">{point.key}</span><br>'},navigation:{buttonOptions:{align:"left"}}});return{basic:d,timeline:b,kiosk:a,sparkline:c}},_seriesProperties:function(a,d,c){var b=a.dataType.split("_"),e=ss.devices.allNodesById[a.deviceID]?" ("+ss.devices.allNodesById[a.deviceID].label+
")":"",f={};"V"===b[0]&&"prime"===b[1]?f={name:"Voltage (Inference) "+e,color:"#f16eaa",axisLabel:"Volts"}:"V"===b[0]?f={name:"Voltage"+e,color:"#9e005d",axisLabel:"Volts"}:"Vi"===b[0]?f={name:"Voltage in"+e,color:"#f16eaa",axisLabel:"Volts"}:"Vo"===b[0]?f={name:"Voltage out"+e,color:"#9e005d",axisLabel:"Volts"}:"P"===b[0]&&g("body#page_kiosk").length?f={name:"Power"+e,color:"#06c",axisLabel:"Watts"}:"P"===b[0]?f={name:"Power"+e,color:"#06c",axisLabel:"Watts"}:"Po"===b[0]&&!b[1]?f={name:"AC out"+
e,color:"#7fbfff",axisLabel:"Watts"}:"Pi"===b[0]&&!b[1]?f={name:"DC in"+e,color:"#a67c52",axisLabel:"Watts"}:"Pi"===b[0]?f={name:"Power in"+e,color:"#7fbfff",axisLabel:"Watts"}:"Po"===b[0]&&"sum"!==b[1]?f={name:"Power out"+e,color:"#06c",axisLabel:"Watts"}:"Po"===b[0]&&"sum"===b[1]?f={name:"Power out"+e,color:"#06c",axisLabel:"Watts"}:"I"===b[0]?f={name:"Current"+e,color:"#00a651",axisLabel:"Amps"}:"Ii"===b[0]?f={name:"Current in"+e,color:"#acd473",axisLabel:"Amps"}:"Io"===b[0]?f={name:"Current out"+
e,color:"#00a651",axisLabel:"Amps"}:"RSSI"===b[0]?f={name:"Radio signal strength",color:"#999",axisLabel:"Signal to noise ratio",min:-100,max:0}:"irradiance"===b[0]||"Irradiance"===b[0]&&"sum"!==b[1]?f={name:"Irradiance",color:"#ffb218",axisLabel:"Irradiance (W/m\u00b2)"}:"irradiance"===b[0]||"Irradiance"===b[0]&&"sum"===b[1]?f={name:"Insolation",color:"#ffb218",axisLabel:"Insolation (kWh/m\u00b2)"}:"energy"===b[0]||"Energy"===b[0]?f={name:"DC Energy",color:"#06c",axisLabel:"kiloWatt hours"}:"acenergy"===
b[0]||"ACEnergy"===b[0]?f={name:"AC Energy",color:"#6ca5d9",axisLabel:"kiloWatt hours"}:"efficiency"===b[0]||"Efficiency"===b[0]||"cleanliness"===b[0]||"Cleanliness"===b[0]?f={name:"Soiling",axisLabel:"Percent",color:"#00a651",fillOpacity:0.75}:"health"===b[0]||"Health"===b[0]?f={name:"Health",axisLabel:"Percent",color:"#9e005d",fillOpacity:0.75}:"temperature"===b[1]&&("panel"===b[0]?f={name:"Panel Temperature",axisLabel:"Degrees Celsius",color:"#FF7F00"}:"ambient"===b[0]&&(f={name:"Ambient Temperature",
axisLabel:"Degrees Celsius",color:"#E41A1C"}));if(1<c.series.length)for(var e=0,h=c.series.length;e<h;e++)d!==e&&(c.series[e].dataType===a.dataType&&c.series[e].deviceType===a.deviceType)&&(f.color=ss.charts.seriesColors[d]);if("strcalc"===a.deviceType||"invcalc"===a.deviceType||"arraycalc"===a.deviceType)if("Pi"===b[0]||"Vi"===b[0]||"Ii"===b[0]||"Po"===b[0]||"Vo"===b[0]||"Io"===b[0])a=f.name.split(" "),f.color="#ddd",f.name=a[0]+" "+a[1]+" avg";if("stdev"===b[1]||"min"===b[1]||"max"===b[1])a=f.name,
f.color="",f.name=a+" ("+b[1]+")";if(0===d)f.yAxis=0;else{e=0;for(h=c.series.length;e<h;e++)if(f.axisLabel===c.series[e].axisLabel||!c.series[e].axisLabel){f.yAxis=e;break}}return f},seriesColors:"#8DD3C7 #4DAF4A #FF7F00 #F781BF #E41A1C #FFFF33 #A65628 #377EB8 #BEBADA #FB8072 #80B1D3 #B3DE69 #984EA3 #FCCDE5 #D9D9D9 #BC80BD #FDB462 #CCEBC5 #FFED6F #0066cc".split(" "),chart:{_init:function(a,d){this.options=g.extend({},this.options,a);for(var c in this.options)if("deviceType"===c||"deviceID"===c||"dataType"===
c)"string"===typeof this.options[c]&&(this.options[c]=this.options[c].split("+"));this.$element=g(ss.charts.template(this.options));this.element=this.$element[0];this.$element.data("module",this);d?g(d).append(this.$element):g(".container_modules").append(this.$element);this.options.title?this.$element.find("h3").text(this.options.title.replace(/\+/g," ")):this.$element.find(".title").remove();this.series=[];this._dataRequested=this.options.deviceID.length;this._dataLoaded=0;var b=this;this.$element.hasClass("fullHeight")&&
require(["static/_build/scripts/modules/layoutHelpers"],function(){b.fullHeight=ss.layouts.fullHeight;b.fullHeight();g(window).smartresize(function(){b.fullHeight()})});this._chartOptions=ss.charts._chartOptions();c=0;for(var e=b.options.deviceID.length; c<e; c++)b._getData(c);b._addListeners()},_parseData:function(a, d){var c=this,b=function(a){if(a&&"object"===typeof a){var b=a;if(0===c.series.length)c.series.push(b);else for(var a=0,d=c.series.length; a<d; a++)c.series[a].dataType===b.dataType&&c.series[a].deviceID===b.deviceID?
g.extend(c.series[a],b):d-1===a&&c.series.push(b)}else throw"Series object not provided or not correct format";};if(a.cols)if(a.data[0])for(var e=0,f=a.data[0][1].length;e<f;e++)for(var h=0,j=a.cols.length;h<j;h++){var k={data:[],dataType:a.cols[h],deviceID:a.data[0][1][e][0],deviceType:c.options.deviceType[d],xAxis:0,threshold:1E-5},i;i=k.dataType.split("_");i="I"===i[0]||"Io"===i[0]||"Ii"===i[0]?3:"V"===i[0]||"Vo"===i[0]||"Vi"===i[0]?2:"sum"===i[1]?2:"Cleanliness"===i[0]||"Health"===i[0]?2:"temperature"===
i[1]?1:0;for(var l=0,p=a.data.length;l<p;l++)if(a.data[l][1][e])for(var n=0,q=a.data[l][1][e][1].length;n<q;n++){var o=a.data[l][0].split("-"),m=a.data[l][1][e][1][n][0].split(":");k.data.push([Date.UTC(+o[0],+o[1]-1,+o[2],+m[0],+m[1]),roundNumber(a.data[l][1][e][1][n][h+1],i)])}b(k)}else{ss.modules.create("messages",c.$element[0],{type:"notification",content:"Some data is unavailable",closable:!1,css:{position:"absolute",top:30,left:0,"z-index":100}});h=0;for(j=a.cols.length;h<j;h++)b({data:[],dataType:a.cols[h],
deviceID:c.options.deviceID[d],deviceType:c.options.deviceType[d],xAxis:0,threshold:1E-5})}else c.series.push({data:a.data,xAxis:0,yAxis:0}),c.options.axisLabels=a.labels},_getData:function(a){var d=this,c=function(){d.chart?d._updateData():d._build()};this.dataDefer||(this.dataDefer=[]);if(this.options.data)this.series.push({data:this.options.data,xAxis:0,yAxis:0}),d.options.axisLabels||(d.options.axisLabels=["X Axis","Y Axis"]),this._build();else{var b=g.ajax({url:"function"===typeof this.options.path?
this.options.path(a):this.options.path,cache:!1,async:!0,success:function(b){++d._dataLoaded;d._parseData(b,a);if(d._dataLoaded===d._dataRequested){d._dataLoaded=0;window.Sentalis&&!Sentalis.currentProject.attributes.spti_enabled?c():require(["static/_build/scripts/modules/devices"],function(a){a.dataDefer.done(function(){c()})})}},error:function(){++d._dataLoaded;ss.modules.create("messages",d.$element[0],{type:"error",content:"Data failed to load",css:{position:"absolute",top:30,left:0,"z-index":100}});d.$element.children(".content").children("img.loading").hide();
d._parseData({},a);if(d._dataLoaded===d._dataRequested){d._dataLoaded=0;window.Sentalis&&!Sentalis.currentProject.attributes.spti_enabled?c():require(["static/_build/scripts/modules/devices"],function(a){a.dataDefer.done(function(){c()})})}}});this.dataDefer.push(b)}},_sortSeries:function(){this.series.sort(function(a, d){var c=ss.devices.allNodesById[a.deviceID]&&"SiteArray"!==ss.devices.allNodesById[a.deviceID].devtype?+ss.devices.allNodesById[a.deviceID].label.replace(/\D/g,""):0,b=ss.devices.allNodesById[d.deviceID]&&"SiteArray"!==
ss.devices.allNodesById[d.deviceID].devtype?+ss.devices.allNodesById[d.deviceID].label.replace(/\D/g,""):0;return c<b?-1:c>b?1:0})},_build:function(){var a=this,d;1<this.series.length&&"area"!==this.options.chartType&&this._sortSeries();d=g.extend(!0,{},this._chartOptions[this.options.template]);this.options.chartType&&(d.chart.type=this.options.chartType);if(this.options.axisLabels)d.xAxis[0].title.text=this.options.axisLabels[0],d.yAxis[0].title.text=this.options.axisLabels[1];else{for(var c=0,
b=this.series.length;c<b;c++){var e={dataType:this.series[c].dataType,deviceType:this.series[c].deviceType,deviceID:this.series[c].deviceID};e.dataType&&e.deviceType&&g.extend(this.series[c],ss.charts._seriesProperties(e,c,this));d.yAxis[this.series[c].yAxis].title.text=this.series[c].axisLabel}if("area"===this.options.chartType){for(var e=25,f=0,h=this.series[0].data.length;f<h;f++){for(var j=0,c=0,b=this.series.length;c<b;c++)j+=Math.abs(this.series[c].data[f][1]);j>e&&(25<j&&50>j?e=50:50<j&&(e=
100))}d.yAxis[this.series[0].yAxis].min=-e;d.yAxis[this.series[0].yAxis].max=0}}if(this.options.seriesColors){c=0;for(b=this.series.length;c<b;c++)this.series[c].color=this.options.seriesColors[c]}g("#page_summary").length&&(d.tooltip.xDateFormat="%e %b");d.chart.renderTo=this.$element.find(".content")[0];d.series=g.extend(this.series,[]);this.series.length&&15<this.series.length&&!this.$element.find(".module").hasClass("fullHeight")?(c=360,20<this.series.length?c=480:18<this.series.length&&(c=420),
this.$element.find(".content").animate({height:c},250,function(){a.chart=new m.Chart(d)})):this.chart=new m.Chart(d);(!0===this.options.downloadWidget||"true"===this.options.downloadWidget)&&this.$element.find(".content").append('<div class="downloadData">Download Chart Data: <a href="#csv">CSV</a></div>');this.$element.find("img.loading").hide()},_updateData:function(){for(var a=0,d=this.chart.series.length;a<d;a++)this.chart.series[a].setData(this.series[a].data);this.$element.find("img.loading").hide()},
update:function(){this.dataDefer=[];0>=this.$element.find("img.loading").length?this.$element.find(".content").append('<img src='+ss.urls.src+'"../../../images/icon_loading.gif" class="loading">'):this.$element.find("img.loading").show();this.$element.find(".message").remove();for(var a=0,d=this.chart.series.length;a<d;a++)this.series[a].data=[];a=0;for(d=this.options.deviceID.length;a<d;a++)this._getData(a)},downloadData:function(a,d){for(var c=[],b=this.options.deviceType,e=0,f=b.length;e<f;e++)for(var h=
this.options.dataType[e].split("-"),j=function(a,c){var d=h[a].split("_")[0],e=b[c];if("arraycalc"===e||"strcalc"===e||"invcalc"===e)switch(d){case "P":return"power";case "V":return"voltage";case "I":return"current";case "Pi":return"average power for panels on this parent node";case "Vi":return"average voltage for panels on this parent node";case "Ii":return"device average current for panels on this parent node";default:"unknown"}else return"Po"===d||"Pi"===d?"power":"Vo"===d||"Vi"===d?"voltage":
"Io"===d||"Ii"===d?"current":"irradiance"===d?"irradiance":d},k=0,i=h.length;k<i;k++)c.push('<p><a href="'+this.options.path(e).replace(this.options.dataType[e],"")+h[k]+"/300/"+d+'">'+j(k,e)+" ("+d+")</a></p>");ss.modules.create("messages",{content:c.join(""),type:"popUp",title:"Download device data"},g("body")[0])},_chartTimeIndicator:function(a){this.chart.xAxis[0].removePlotLine("timeIndicator");this.chart.xAxis[0].addPlotLine({color:"#aaa",width:1,value:a,id:"timeIndicator",dashStyle:"ShortDot"})},
_destroyChartTimeIndicator:function(){this.chart.xAxis[0].removePlotLine("timeIndicator")},destroy:function(){this.chart&&this.chart.destroy();if(this.dataDefer)for(var a=0,d=this.dataDefer.length;a<d;a++)this.dataDefer[a].abort();this.$element.remove();this.$element.off();g(document).unbind(".chart."+this.options.id)},_addListeners:function(){var a=this;this.$element.hover(function(){g(this).find(".downloadData").fadeIn(250)},function(){g(this).find(".downloadData").fadeOut(250)});this.$element.delegate(".downloadData a",
"click",function(c){c.preventDefault();a.downloadData(this,g(this).attr("href").replace("#",""))});(!0===this.options.autoUpdate||"true"===this.options.autoUpdate)&&g(document).bind("updateModules.chart."+this.options.id,function(){a.update()});g(document).bind("mapPlay.chart."+this.options.id,function(c,b){a.chart&&(b.stop?a._destroyChartTimeIndicator():a._chartTimeIndicator(b.utcDate))});var d=function(){if(a.dataDefer)for(var c=0,b=a.dataDefer.length;c<b;c++)a.dataDefer[c].abort()};g(document).bind("setDevice.chart."+
this.options.id,function(){d()});g(window).bind("unload.chart."+this.options.id,function(){d()})},options:{title:"Chart",chartType:"line",autoUpdate:!0,downloadWidget:!0,template:"timeline",deviceID:["Array"],path:function(a){if(this.deviceType)switch(this.deviceType[a]){case "env":return ss.urls.timelineDataEnv+this.deviceType[a]+"/"+this.dataType[a];case "Site_Array":return this.dataType[a];default:return ss.urls.timelineDataDevice+this.deviceID[a]+"/"+this.deviceType[a]+"/"+this.dataType[a]}}}}};
return ss.charts.chart});