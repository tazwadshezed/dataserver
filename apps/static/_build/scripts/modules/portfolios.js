/*
 Copyright 2013 Draker - Pats Pending
*/
define(["jquery","static/_build/scripts/modules/urls","dataTables","utils"],function(d){ss.portfolios={template:function(){return'<table class="basic portfolio sort">;<thead>;<tr>;<th>Site</th>;<th>Status</th>;<th>Energy YTD (in MWh)</th>;<th>Soiling Loss (%)</th>;<th>Health Loss (%)</th>;<th>Perf Ratio (%)</th>;<th>DC Nameplate (in kWp)</th>;<th>Actions</th>;</tr>;<thead>;<tbody></tbody>;</table>'.split(";")},portfolio:{_init:function(c, b){this.options=d.extend({},this.options,c);this.$element=d(ss.portfolios.template(c).join(""));
this.element=this.$element[0];b?d(b).append(this.$element):d(".container_modules").append(this.$element);this._getData();var a=this;this.$dfr.done(function(){a.$element.dataTable({bPaginate:!1,bInfo:!1})});this._updateInterval=setInterval(function(){a._getData()},3E5)},_getData:function(){for(var c=this,b="",a=0,f=this.options.sites.length;a<f;a++)var e=this.options.sites[a],b=0===b.length?e.callsign:b+","+e.callsign;this.$dfr=d.ajax({url:ss.urls.portfolioData+b,type:"GET",cache:!1,async:!0,success:function(a){c.siteData=
a.portfolio_data;c._populateTable()},error:function(){c.$element.find("tbody").append('<tr><td colspan="6"><span class="message error">Data failed to load</span></td></tr>')}})},_populateTable:function(){var c=this.$element.find("tbody");for(site in this.options.sites){var b=this.options.sites[site],a=this.siteData[b.callsign],f=b.name,e=!a.energy_YTD?'<span class="noData">No data</span>':"TBD"===a.energy_YTD?"TBD":roundNumber(a.energy_YTD/1E6,1),i=!a.cleanliness?'<span class="noData">No data</span>':
roundNumber(a.cleanliness,1),j=!a.health?'<span class="noData">No data</span>':roundNumber(a.health,1),g=!a.performance_ratio?'<span class="noData">No data</span>':"N/A"===a.performance_ratio?'<span class="disabled">n/a</span>':roundNumber(a.performance_ratio,0),k=!a.DC_nameplate?'<span class="noData">No data</span>':"TBD"===a.DC_nameplate?"TBD":a.DC_nameplate,l="S"===ss.user.role?'<a href="'+b.detailsURL+'" class="button secondary">Superuser Site Info</a>':"",m="K"===ss.user.role?b.url.length?'<a href="'+
b.url+"/ss/kiosk/"+b.callsign+'" class="button secondary">View Kiosk</a>':'<a href="#" class="button secondary disabled">View Kiosk</a>':b.url.length?'<a href="'+b.url+"/ss/setarray/"+b.callsign+'" class="button primary">View Live Site</a>':'<a href="#" class="button primary disabled">View Live Site</a>',h=function(){switch(a.issue_level){case "Data Collection Down":return'<span class="value alert">5 '+a.issue_level+"</span>";case "Emergency":return'<span class="value alert">6 '+a.issue_level+"</span>";
case "Serious":return'<span class="value warning">3 '+a.issue_level+"</span>";case "Problem":return'<span class="value ss">4 '+a.issue_level+"</span>";case "Warning":return'<span class="value warning">2 '+a.issue_level+"</span>";case "Notice":return'<span class="value info">1 '+a.issue_level+"</span>";default:return'<span class="value">0 OK</span>'}}();d("tr#site_"+site).length?(myTR=d("tr#site_"+site),myTR.find("td.issueLevel").html(h),myTR.find("td.energyYTD").html(e),myTR.find("td.perfRatio").html(g)):
c.append(['<tr id="site_'+site+'">','<td class="siteName"><a href="'+b.url+"/ss/setarray/"+b.callsign+'">'+f+"</a></td>",'<td class="issueLevel">'+h+"</td>",'<td class="energyYTD">'+e+"</td>",'<td class="soiling">'+i+"</td>",'<td class="health">'+j+"</td>",'<td class="perfRatio">'+g+"</td>",'<td class="DCNameplate">'+k+"</td>",'<td class="actions">'+m+l+"</td>","</tr>"].join(""))}},_update:function(){},options:{sites:""}}};return ss.portfolios.portfolio});