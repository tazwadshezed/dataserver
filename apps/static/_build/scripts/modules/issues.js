/*
 Copyright 2012 Draker Inc - Pats Pending
*/
define(["jquery","static/_build/scripts/modules/urls","devices"],function(b, j, h){ss.issues={template:function(d){return['<div id="'+d.id+'" class="module interactive issues '+(d.addClass||"")+'">','<div class="title"><h3>Loading...</h3><div class="controls"><ul>',"faults"!==d.issue_type?'<li class="help"><a href="#help?position=left&amp;width=300" class="link_hover">?</a></li>':"",'</ul></div></div><div class="content">','<img src='+ss.urls.src+'"../../../images/icon_loading.gif" class="loading">',"</div></div>"].join("")},issue:{_init:function(d,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         c){this.options=b.extend({},this.options,d);this.$element=b(ss.issues.template(d));this.element=this.$element[0];this.$element.data("module",this);c?b(c).append(this.$element):b(".container_modules").append(this.$element);this.options.title?this.$element.find(".title").children("h3").text(this.options.title.replace(/\+/g," ")):this.$element.find(".title").remove();var a=this;this.$element.hasClass("fullHeight")&&require(["static/_build/scripts/modules/layoutHelpers"],function(){a.fullHeight=ss.layouts.fullHeight;a.fullHeight();
b(window).smartresize(function(){a.fullHeight()})});a.$element.find(".link_hover")&&h.dataDefer.done(function(){ss.modules.create("hovers",{position:"left",width:300,content:"<p>Issues are generated by the Intelligent Array System based on your array's business rules.</p><a href=\""+ss.urls.comm+"/admin/show_rules/"+h.allNodesByType.SiteArray.label+'" class="action">View/Edit Business Rules</a>',attachTo:a.$element.find(".link_hover").get()})});ss.issueData&&ss.issueData[a.options.issue_type]?(a.issues=
ss.issueData[a.options.issue_type],a._populateIssues()):a._getData();a._addListeners()},_getData:function(){var d=this;ss.issueData||(ss.issueData={});b.ajax({url:ss.urls[d.options.issue_type],cache:!1,async:!0,success:function(c){ss.issueData[d.options.issue_type]=c[d.options.issue_type];d.issues=c[d.options.issue_type];h.dataDefer.done(function(){d._populateIssues()})},error:function(){ss.modules.create("messages",d.$element.find(".content")[0],{type:"error",content:"Data failed to load",css:{position:"absolute",
top:0,left:0,"z-index":100}});d.$element.find("img.loading").hide()}})},sortIssues:function(){"issues"===this.options.issue_type?this.issues.sort(function(d,c){if(d.Priority===c.Priority){var a=d.ProblemDate.split("/"),b=c.ProblemDate.split("/"),a=a[2]+a[0]+a[1],b=b[2]+b[0]+b[1];return a>b?-1:a<b?1:0}return c.Priority-d.Priority}):"faults"===this.options.issue_type&&this.issues.sort(function(b,c){aImpact=+b.energy_loss/+b.duration||0;bImpact=+c.energy_loss/+c.duration||0;return aImpact>bImpact?-1:
aImpact<bImpact?1:0})},_populateIssues:function(){var d,c=this;this.sortIssues();this.$element.find("img.loading").hide().css({right:0});this.$element.find("ul.issueList").length?(d=this.$element.find("ul.issueList"),this.$element.find("ul.issueList li").remove()):(d=b('<ul class="issueList" />'),this.$element.find(".content").append(d));if(this.issues&&0<this.issues.length)for(var a=0,e=this.issues.length;a<e;a++){var g,f=function(){switch(c.issues[a].level?c.issues[a].level:c.issues[a].Level){case "Data Collection Down":return"alert";
case "Emergency":return"alert";case "Serious":return"warning";case "Problem":return"ss";case "Warning":return"warning";case "Notice":return"info";default:return"info"}};if(null!==this.issues[a].device_id){if("issues"===this.options.issue_type.toLowerCase()){g=['<li id="issue_'+this.issues[a].id+'" class="issue '+f()+'">'];if(c.issues[a].StateChanges&&c.issues[a].StateChanges[0])var f=c.issues[a].StateChanges[0][1].split(" "),i=f[0].split("-"),f="</strong> &nbsp;|&nbsp; <strong>Last Observed</strong>: "+
i[1]+"/"+i[2]+"/"+i[0]+" at "+(f[1]+" "+f[2]);else f="";g.push("<h5>"+this.issues[a].Summary+'</h5><p class="date"><strong>Created on</strong>: '+this.issues[a].ProblemDate+" by <strong>"+this.issues[a].Creator+f+"</strong> &nbsp;|&nbsp; <strong>Status</strong>: "+this.issues[a].Status+"</p><p>"+this.issues[a].Description+"</p>");g.push(function(){var b=['<ul class="actions">'];c.issues[a].Node!=""&&(c.issues[a].Node.length>0&&c.issues[a].Node!=void 0&&c.issues[a].Node!=null)&&b.push('<li><a href="/ss/dashboard/#'+
c.issues[a].Node+'" class="deviceNavigation">View device</a></li></ul>');b.push("</li>");return b.join("")}());g.data(this.issues[a])}else"faults"===this.options.issue_type.toLowerCase()?(g=['<li id="fault_'+this.issues[a].id+'" class="issue info">'],f=h.allNodesById[this.issues[a].device_id],g.push("<h5>"+f.devtype+" "+f.label+" "+this.issues[a].category+'</h5><p class="date"><strong>Created on</strong>: '+this.issues[a].starttime+" | <strong>Last Observed</strong>: "+this.issues[a].endtime+'</p><ul class="actions"><li><a href="#'+
c.issues[a].device_id+'" class="deviceNavigation">View device</a></li></ul>'),g.push("</li>")):"alerts"===this.options.issue_type.toLowerCase()&&(g=['<li id="alert_'+this.issues[a].id+'" class="issue '+this.issues[a].level.toLowerCase()+'">'],f=this.issues[a].device_id?h.allNodesById[this.issues[a].device_id]:null,i=this.issues[a].description?"<p>"+this.issues[a].description.join(" ")+"</p>":"",g.push("<h5>"+this.issues[a].title+'</h5><p class="date"><strong>Created on</strong>: '+this.issues[a].created_at+
"</p>"+i),f&&"SiteArray"!==f.devtype&&g.push('<ul class="actions">','<li><a href="/ss/dashboard/#'+f.id+'" class="deviceNavigation">View device</a></li>',"</ul>"),g.push("</li>"));this.options.node?(this.issues[a].Node===this.options.node||this.issues[a].device_id===this.options.node)&&d.append(b(g.join(""))):d.append(b(g.join("")))}}else this.issues&&0>=this.issues.length&&(e=new Date,d.append('<li class="issue"><h5>No issues reported</h5><p class="date">Updated on <strong>'+e.getFullYear()+"-"+
(e.getMonth()+1)+"-"+e.getDate()+"</strong></li>"));0>=this.$element.find(".issue").length&&(e=new Date,d.append('<li class="issue"><h5>No issues reported</h5><p class="date">Updated on <strong>'+e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()+"</strong></li>"))},filter:function(d){this.$element.find("img.loading").show();this.$element.find(".content p.noIssues").remove();d.filterValue&&"!"===d.filterValue.charAt(0)?b.each(b(".issue"),function(){var c=b(this).data(),a=d.filterValue.replace("!",
"");c[d.filterBy]!=a?b(this).show():b(this).hide()}):b.each(b(".issue"),function(){b(this).data()[d.filterBy]==d.filterValue?b(this).show():b(this).hide()});issue=0;for(issuesLength=b(".issue").length;issue<issuesLength&&!b(".issue").is(":visible");issue++)issue==issuesLength-1&&this.$element.find(".content").prepend('<p class="noIssues">No issues found</p>');b(".issue").is(":visible");this.$element.find("img.loading").hide()},archive:function(d){this.$element.find("img.loading").show();b("a.issueFilter").removeClass("active");
this.filter({});var c=this;b.ajax({url:ss.urls[this.options.issue_type]+d.archive,cache:!1,success:function(a){b("ul.list_issueFilters").length&&b("ul.list_issueFilters").prepend('<li><a href="#?filterBy=Status&amp;filterValue=closed" class="issueFilter">Closed Issues</a></li>').prepend('<li><a href="#?filterBy=Status&amp;filterValue=!closed" class="issueFilter">Open Issues</a></li>');b.merge(c.issues,a.issues);c.sortIssues();c.$element.find("ul.issueList").remove();c._populateIssues()},error:function(){ss.modules.create("messages",
c.$element.find(".content")[0],{type:"error",content:"Archived issues failed to load",css:{position:"absolute",top:0,left:0,"z-index":100}})}})},update:function(){this.$element.find(".message").remove();this.$element.find("img.loading").css({display:"",top:0});this._getData()},destroy:function(){this.$element.remove();this.$element.off();b(document).unbind(".issue."+this.options.id)},_addListeners:function(){var d=this;this.$element.delegate("a.deviceNavigation","click",function(){var c=b(this).attr("href").split("#")[1];
b(document).trigger("setDevice",{deviceId:c})});b("body").delegate("a.issueFilter","click",function(c){c.preventDefault();b("a.issueFilter").removeClass("active");b(this).hasClass("clear")||b(this).addClass("active");var c=b(this).attr("href").replace("#?","").split("&"),a={};for(option=0;option<c.length;option++){var e=c[option].split("=");a[e[0]]=e[1]}d.filter(a)});b("body").delegate("a.issueArchive","click",function(c){c.preventDefault();b(this).replaceWith('<span class="text_disabled">'+b(this).text()+
"</span>");var c=b(this).attr("href").replace("#?","").split("&"),a={};for(option=0;option<c.length;option++){var e=c[option].split("=");a[e[0]]=e[1]}d.archive(a)});b(document).bind("updateModules.issue."+this.options.id,function(){d.update()})},options:{title:"Issues",issue_type:"issues",filterBy:null,filterValue:null,sort:"date",node:!1}}};return ss.issues.issue});