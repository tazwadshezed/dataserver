/*
 Copyright 2012 Draker Inc - Pats Pending
*/
define("jquery jquery-ui raphael urls devices messages popUps dates utils".split(" "),function(e,q,r,s,g){ss.maps={template:function(a){return['<div id="'+a.id+'" class="module interactive map '+(a.addClass||"")+'">','<div class="title">',"<h3>Loading...</h3>","</div>",'<div class="content">','<img src='+ss.urls.src+'"../../../images/icon_loading.gif" class="loading">',"</div>","</div>"]},map:{_init:function(a,d){this.options=e.extend({},this.options,a);this.$element=e(ss.maps.template(a).join(""));this.element=
this.$element[0];this.$element.data("module",this);d?e(d).append(this.$element):e(".container_modules").append(this.$element);this.options.title?this.$element.find("h3").text(this.options.title.replace(/\+/g," ")):this.$element.find("h3").text("Array Map");var b=this;this.$element.hasClass("fullHeight")&&require(["static/_build/scripts/modules/layoutHelpers"],function(){b.fullHeight=ss.layouts.fullHeight;b.fullHeight();e(window).smartresize(function(){b.fullHeight()});b.resetPosition()});g.dataDefer.done(function(){var f=b.options.startingDevice?
b.options.startingDevice:window.location.hash.replace("#","")||false,c=f&&g.allNodesById[f]?g.allNodesById[f].devtype:false;if(!a.defaultRotation&&g.allData)b.options.defaultRotation=g.allData.sitearray.pref_rotation;if(!a.northOffset&&g.allData)b.options.northOffset=g.allData.sitearray.north_offset;b.panelWidth=roundNumber(+g.allData.sitearray.std_panel_xoffset,3);b.panelHeight=roundNumber(+g.allData.sitearray.std_panel_yoffset,3);b._currentDeviceType=c&&c!=="SiteArray"?c:"Inverter";b._currentNode=
f&&g.allNodesById[f].parent?g.allNodesById[f].parent:g.allNodesByType.SiteArray.id;b._selectedDevice=f;if(g.allNodesByType.Inverter&&g.allNodesByType.Inverter.length){b._buildCanvas();b._buildCompass();b.options.controls&&b._buildControls();b._buildArray();b.resetPosition();b.options.overlays&&b._overlayInit();if(b.options.inverterStatus){if(!ss.issueData)ss.issueData={};!ss.issueData.acAlarms&&window.Sentalis?e.ajax({url:"/projects/"+Sentalis.currentProject.id+"/alarms/dashboard.json?by_alarm_type=InverterFaultAlarm",
cache:false,success:function(a){if(!ss.issueData)ss.issueData={};ss.issueData.acAlarms=a;b._inverterStatus()},error:function(){}}):b._inverterStatus()}}else if(g&&g.allNodesByType.Inverter&&g.allNodesByType.Inverter.length<=0){b.$element.find("img.loading").hide();ss.modules.create("messages",b.$element.find(".content")[0],{type:"notification",content:"No devices found",autoDie:2E3,closable:false,css:{position:"absolute",top:0,left:0,"z-index":100}})}else{b.$element.find("img.loading").hide();ss.modules.create("messages",
b.$element.find(".content")[0],{type:"error",content:"Device data failed to load",autoDie:2E3,css:{position:"absolute",top:0,left:0,"z-index":100}})}b.hilite();b._addListeners()})},_buildCanvas:function(){var a=e('<div id="mapCanvas_'+this.options.id+'" class="mapCanvas" />').css({width:3E3,height:3E3});this.options.draggable&&a.draggable();this.$element.find(".content").append(a);this.array=Raphael("mapCanvas_"+this.options.id,3E3,3E3)},_buildControls:function(){this.$element.find(".content").append('<ul class="controls"><li class="zoom"><a href="#zoom_in" class="zoomIn"><span>Zoom In</span></a> <a href="#zoom_out" class="zoomOut"><span>Zoom Out</span></a></li><li class="rotate"><a href="#rotate_left" class="rotateLeft"><span>Rotate Left</span></a> <a href="#rotate_right" class="rotateRight"><span>Rotate Right</span></a></li><li class="center"><a href="#center" class="center"><span>center</span></a></li><li class="reset"><a href="#reset" class="reset"><span>Reset</span></a></li></ul>');
var a=['<ul class="controls_top">','<li class="selectOverlayType">','<label for="overlayType">Overlay type </label> ','<select class="overlayType" name="overlayType">','<option value="faults">Faults</option>','<option value="E">Clarity Performance Index</option>','<option value="N">Power Relative to Array Average</option>','<option value="A">Power Output Compared to Panel Rating</option>',"</select>","</li>",'<li class="globalViews">',"<span>Quick view </span> ","<ul></ul>","</li>",'<li><img src='+
ss.urls.src+'"../../../images/icon_loading.gif" class="loading"></li>',"</ul>"];this.$element.find("img.loading").remove();this.$element.find(".content").append(a.join(""));for(var a=1,d=g.nodeTypes.length;a<d;a++){var b=g.nodeTypes[a],f=e('<li><a href="#changeView?deviceType='+b+"&node="+g.allNodesByType.SiteArray.id+'" class="changeView">All '+b+"s</a> </li>"),c=this._deviceLimit(b);g.allNodesByType[b].length>c&&f.find("a.changeView").addClass("disabled");this.$element.find("li.globalViews > ul").append(f)}ss.user.role===
"S"&&this.$element.find("select.overlayType").append('<option value="R">Data reports</option>')},_buildArray:function(){var a=this;a.deviceSet=a.array.set();var d=function(b){return b==="Panel"?{cursor:"pointer",width:a.panelWidth,height:a.panelHeight,fill:"#999",opacity:1,stroke:"#eee","stroke-width":0.5}:b==="SiteArray"?{fill:"#efefef",opacity:1,stroke:0}:{cursor:"pointer",fill:"#999",opacity:1,stroke:"#eee","stroke-width":0.5}},b=this._deviceLimit(this._currentDeviceType),b=g.allNodesByType[this._currentDeviceType].length<
b?true:false,f;f=false;if(a._currentNode){var c=g.allNodesById[g.allNodesById[a._currentNode].parent];if(c&&c.childNodeCount&&c.childNodeCount[a._currentDeviceType]<b)f=c.id}for(var c=0,l=g.allNodesByType[this._currentDeviceType].length;c<l;c++){var i=g.allNodesByType[this._currentDeviceType][c],h=+g.allNodesByType.Panel[c].x,j=+g.allNodesByType.Panel[c].y,k=roundNumber(a.panelWidth,3),o=roundNumber(a.panelHeight,3),p=+g.allNodesByType.Panel[c].angle;if(b||i.isChildOf(this._currentNode)||f&&i.isChildOf(f)){var m;
m=[];if(a._currentDeviceType==="Panel"){k="M"+h+","+j+"L"+(h+k)+","+j+"L"+(h+k)+","+(j+o)+"L"+h+","+(j+o)+"Z";i.attached!=="null"&&i.attached!==null?m.push(a.array.path(k)):m.push(a.array.image(ss.urls.src+"images/maps_panel_na.png",h,j))}else{h=i.shapes.split("+");j=0;for(k=h.length;j<k;j++)m.push(a.array.path(h[j]))}h=0;for(j=m.length;h<j;h++){k=m[h];k.attr(d(this._currentDeviceType)).data("myInfo",i).click(function(){var a=this.data("myInfo");e(document).trigger("setDevice",{deviceId:a.id})}).mouseover(function(){var b=
this.data("myInfo");a.options.hilite&&a.hilite({deviceId:b.id})}).mouseout(function(){a.options.hilite&&a.hilite()});p&&k.transform("r"+p);this.deviceSet.push(k)}}}this.arrayOutline=this.array.path(g.allNodesByType.SiteArray.shapes).attr(d("SiteArray")).toBack();if(!this.siteWidth){var n=this.arrayOutline.getBBox();this.siteWidth=n.width;this.siteHeight=n.height;this.xOffset=n.x;this.yOffset=n.y}this.deviceSet.translate(-this.xOffset-this.siteWidth/2+1500,-this.yOffset-this.siteHeight/2+1500);this.arrayOutline.translate(-this.xOffset-
this.siteWidth/2+1500,-this.yOffset-this.siteHeight/2+1500);this._currentZoom=1;if(this.options.defaultRotation){this.rotate();d=this.arrayOutline.getBBox();this.siteWidth_rotated=d.width;this.siteHeight_rotated=d.height}else{this.siteWidth_rotated=n.width;this.siteHeight_rotated=n.height}this.$element.find("img.loading").hide()},_buildCompass:function(){e(this.$element.find(".content")[0]).append('<div id="compass_'+this.options.id+'" class="compass" />');this.compass=Raphael(["compass_"+this.options.id,
36,36,{type:"image",src:ss.urls.src+"images/maps_compass.png",x:0,y:0,width:36,height:36}]);this.compass[0].rotate(this.options.northOffset)},_inverterStatus:function(){this.deviceSet.attr({fill:"#314452"});this.$element.find(".content").append('<ul class="legend"><li class="legendValue10">OK</li><li class="legendValue06">Problem</li></ul>');for(var a=ss.issueData.acAlarms,d=0,b=this.deviceSet.length;d<b;d++){for(var f=this.deviceSet[d].data("myInfo"),c="<p>Status: OK</p>",e=0,g=a.length;e<g;e++)if(+a[e].system_component_id===
+f.SentalisId){this.deviceSet[d].attr({fill:"#F12727"});c='<p><strong>Status</strong>: <a href="'+a[e].path+'">'+a[e].name+"</a></p>";break}ss.modules.create("hovers",{position:"top",content:"<p><strong>"+f.devtype+"</strong>: "+f.label+"<p>"+c,followMouse:true,attachTo:this.deviceSet[d].node})}},changeView:function(a){this.siteHeight_rotated=this.siteWidth_rotated=0;this.$element.find("img.loading").show();a&&a.hideNodeInfo&&this.destroyNodeInfo();var d=this._currentZoom,b=this._currentRotation;
this.deviceSet.clear();this.array.clear();this._currentDeviceType=a.deviceType||this._currentDeviceType;this._currentNode=a.node||this._currentNode;this.rotate({amount:-this._currentRotation});this._currentRotation=0;this._buildArray();this.zoom({amount:d});this.rotate({amount:b-this._currentRotation});this.update();this.hilite()},hilite:function(a){var d=function(a){/msie/i.test(navigator.userAgent)||a.toFront()};if(a){var b=g.allNodesById[a.deviceId],f=0;for(devicesLength=this.deviceSet.length;f<
devicesLength;f++){var c=this.deviceSet[f].data("myInfo");this._currentDeviceType!=="Inverter"&&c.parent===b.parent&&(c.id!==b.id&&c.id!==this._selectedDevice)&&this.deviceSet[f].attr({stroke:"#f9ad81","stroke-width":1.5});c.id===this._selectedDevice&&this.deviceSet[f].attr({stroke:"#f9ad81","stroke-width":2});if(c.id===a.deviceId){this.deviceSet[f].attr({stroke:"#f26522","stroke-width":2});d(this.deviceSet[f])}}}else if((f=g.allNodesById[this._selectedDevice])&&f.devtype!==this._currentDeviceType&&
f.devtype!=="SiteArray")for(var f=0,a=this.deviceSet.length;f<a;f++){b=this.deviceSet[f];b=b.data("myInfo");if(b.isChildOf(this._selectedDevice)||b.isParentOf(this._selectedDevice)){this.deviceSet[f].attr({"stroke-width":1.5,stroke:"#f9ad81"});d(this.deviceSet[f])}else this.deviceSet[f].attr({stroke:"#eee","stroke-width":0.5})}else{f=0;for(a=this.deviceSet.length;f<a;f++){b=this.deviceSet[f];b=b.data("myInfo");if(b.id===this._selectedDevice){d(this.deviceSet[f]);this.deviceSet[f].attr({"stroke-width":2,
stroke:"#f26522"})}else this.deviceSet[f].attr({stroke:"#eee","stroke-width":0.5})}}},nodeInfo:function(a){e("body#page_dashboard");var a=g.allNodesById[a.node],d=g.allNodesById[a.parent],b=['<div class="nodeInfo">','<div class="header">',"<h5>"+a.devtype+" <strong>"+a.label+"</strong></h5>",'<a href="#close" class="close">Close x</a>',"</div>",'<div class="content">',"<p><strong>Equipment type</strong>:<br> "+(this._currentDeviceType==="String"?"N/A":a&&a.equipment?a.equipment:g.allData.device_types[g.allData.sitearray["std_"+
this._currentDeviceType.toLowerCase()+"_model_number"]]?g.allData.device_types[g.allData.sitearray["std_"+this._currentDeviceType.toLowerCase()+"_model_number"]].name:"Unknown")+"</p>",'<p><strong>Issues</strong>:<br> <span class="issues">Loading...</span></p>',"</div>",'<div class="nav">',"<h5>Device Hierarchy</h5>",'<ul class="nav_devices">','<li><a href="#'+g.allNodesByType.SiteArray.id+'" class="deviceNavigation array">Array</a></li>',"</ul>","</div>",'<div class="view">',"<h5>View Parent/Child Devices</h5>",
'<ul class="view_devices">',"</ul>","</div>","</div>"],b=e(b.join(""));ss.user.role==="S"&&b.find(".content").append('<p><a href="/ss/device_info/'+a.id+'" class="action">View device information</a></p>');for(var f in a.parentNodes)f!=="SiteArray"&&b.find("ul.nav_devices").append('<li><a href="#'+a.parentNodes[f][0]+'" class="deviceNavigation '+f.toLowerCase()+'">'+a.parentNodes[f][1]+"</a></li>");b.find("ul.nav_devices").append('<li><a href="#'+a.id+'" class="deviceNavigation '+g.allNodesById[a.id].devtype.toLowerCase()+
'">'+a.label+"</a></li>");if(a.devtype!=="Inverter"){f=g.allNodesById[d.parent].devtype==="SiteArray"?"":g.allNodesById[d.parent].label;var c=g.allNodesById[d.parent].devtype==="SiteArray"?"Array":g.allNodesById[d.parent].devtype;b.find("ul.view_devices").append('<li><a href="#changeView?deviceType='+d.devtype+"&node="+d.parent+'" class="changeView">'+d.devtype+"s on "+c+" "+f+" &raquo;</a></li>")}if(a.inputs){d=[];f=this._deviceLimit(a.devtype);c=a.inputs[0];d.push('<li><a href="#changeView?deviceType='+
c.devtype+"&node="+a.id+'" class="changeView '+(a.inputs.length>f?"disabled":"")+'">'+c.devtype+"s on "+a.devtype+" "+a.label+" &raquo;</a></li>");if(c.inputs){var l=c.inputs[0];d.push('<li><a href="#changeView?deviceType='+l.devtype+"&node="+a.id+'" class="changeView '+(a.inputs.length*c.inputs.length>f?"disabled":"")+'">'+l.devtype+"s on "+a.devtype+" "+a.label+" &raquo;</a></li>");if(l.inputs){var i=l.inputs[0];d.push('<li><a href="#changeView?deviceType='+i.devtype+"&node="+a.id+'" class="changeView '+
(a.inputs.length*c.inputs.length*l.inputs.length>f?"disabled":"")+'">'+i.devtype+"s on "+a.devtype+" "+a.label+" &raquo;</a></li>");if(i.inputs){var h=h.inputs[0];d.push('<li><a href="#changeView?deviceType='+h.devtype+"&node="+a.id+'" class="changeView '+(a.inputs.length*c.inputs.length*l.inputs.length*i.inputs.length>f?"disabled":"")+'">'+h.devtype+"s on "+a.devtype+" "+a.label+" &raquo;</a></li>")}}}b.find("ul.view_devices").append(d.join(""))}if(ss.issueData.faults){h=[];d=ss.issueData.faults;
f=d.length;for(c=0;c<f;c++)d[c].device_id===a.id&&h.push(a.devtype+" "+a.label+" "+d[c].category);h[0]?b.find(".content p span.issues").text(h[0]):b.find(".content p span.issues").text("None")}else ss.issueData.faults||b.find(".content p span.issues").text("No data");if(e(".nodeInfo").length)this.$element.find(".nodeInfo").replaceWith(b.css({left:0,opacity:0.8}));else{b.appendTo(this.$element.find(".content")).css({opacity:0.8}).animate({left:0});this.$element.find(".controls").animate({left:b.width()});
this.$element.find(".controls_top").animate({left:b.width()})}b.bind("mouseenter",function(){e(this).animate({opacity:1})});b.bind("mouseleave",function(){e(this).animate({opacity:0.8})})},destroyNodeInfo:function(){var a=this.$element.find(".nodeInfo");a.animate({left:-a.width()}).queue(function(){e(this).remove()});this.$element.find(".controls").animate({left:0});this.$element.find(".controls_top").animate({left:0})},resetPosition:function(){this.rotate();this.center();this.zoom()},zoom:function(a){if(a)if(a.direction){var d=
Math.sqrt(2);switch(a.direction){case "+":a=d;break;case "-":a=1/d;break;default:a=a.amount||1}}else a=a.amount||1;else a=Math.min(this.$element.find(".content").width()/this.siteWidth_rotated,this.$element.find(".content").height()/this.siteHeight_rotated)/this._currentZoom*0.8;this.deviceSet.scale(a,a,0+this.siteWidth/2+this.xOffset,0+this.siteHeight/2+this.yOffset);this.arrayOutline.scale(a,a,0+this.siteWidth/2+this.xOffset,0+this.siteHeight/2+this.yOffset);this._currentZoom=this._currentZoom*
a},rotate:function(a){this.deviceSet.getBBox();if(a)if(a.direction)switch(a.direction){case "+":a=a.amount||0;break;case "-":a=-a.amount||0;break;default:a=a.amount||0}else a=a.amount||0;else a=this._currentRotation?+this.options.defaultRotation-this._currentRotation:+this.options.defaultRotation;this._currentRotation=this._currentRotation?this._currentRotation+a:a;this.deviceSet.rotate(a,0+this.siteWidth/2+this.xOffset,0+this.siteHeight/2+this.yOffset);this.arrayOutline.rotate(a,0+this.siteWidth/
2+this.xOffset,0+this.siteHeight/2+this.yOffset);this.compass[0].rotate(a)},center:function(){this.$element.find(".mapCanvas").css({top:-1500+this.$element.find(".content").height()/2,left:-1500+this.$element.find(".content").width()/2})},_overlayInit:function(){var a=this;this._overlays={};this._currentOverlay={};if(ss.issueData&&ss.issueData.faults){this._overlays.faults={type:"faults",name:"faults",data:ss.issueData.faults};this._setOverlayType({type:"faults"})}else{this.$element.find("img.loading").show();
e.ajax({url:ss.urls.faults,cache:false,timeout:3E4,success:function(d){a._overlays.faults={type:"faults",name:"faults",data:d.faults};if(!ss.issueData)ss.issueData={};ss.issueData.faults=d.faults;a.$element.find("img.loading").hide();a._setOverlayType({type:"faults"})},error:function(){a._overlays.faults={type:"faults",name:"faults",data:null,error:"Data failed to load"};a.$element.find("img.loading").hide();a._setOverlayType({type:"faults"});ss.modules.create("messages",a.$element.find(".content")[0],
{type:"error",content:"There was an error loading faults",autoDie:2E3,css:{position:"absolute",top:0,left:0,"z-index":100}})}})}},_setOverlayType:function(a){this._currentOverlay.type=a.type;if(!this._currentOverlay.timeslice)this._currentOverlay.timeslice=0;this._currentOverlay.playing=false;this._clearOverlay();this.$element.find("ul.legend").remove();this._buildLegend();if(a.type=="faults"){this._overlays.faults.data=ss.issueData.faults;this._paintPanels({type:"faults"});this.$element.find("li.time").remove();
e(document).trigger("mapPlay",{stop:true})}else if(this._overlays[a.type])if(this._overlays[a.type].dateMin===ss.dates.min()&&this._overlays[a.type].dateMin===ss.dates.min()&&this._overlays[a.type].deviceType===this._currentDeviceType){this._paintPanels();this._buildTimeControls()}else this._getOverlayData({type:a.type});else this._getOverlayData({type:a.type})},_getOverlayData:function(a){var d=this;this.$element.find("img.loading").show();if(!this.dataDefer)this.dataDefer=[];var b=e.ajax({url:ss.urls.heatMap+
a.type+"/"+this._currentDeviceType.toLowerCase(),cache:false,timeout:6E4,success:function(b){d.$element.find("img.loading").hide();d._overlays[a.type]={data:b.panel_heat,dateMin:ss.dates.min(),dateMax:ss.dates.max(),deviceType:this._currentDeviceType};if(b.panel_heat.length>0){d._paintPanels();d._buildTimeControls()}else ss.modules.create("messages",d.$element.find(".content")[0],{type:"notification",content:"No data available for selected time range",autoDie:2E3,closable:false,css:{position:"absolute",
top:0,left:0,"z-index":100}})},error:function(){d._overlays[a.type]={data:null,error:"Data failed to load",dateMin:ss.dates.min(),dateMax:ss.dates.max(),deviceType:this._currentDeviceType};d.$element.find("img.loading").hide();ss.modules.create("messages",d.$element.find(".content")[0],{type:"error",content:"Overlay data failed to load",autoDie:2E3,css:{position:"absolute",top:0,left:0,"z-index":100}});d.$element.find("li.time").remove();e(document).trigger("mapPlay",{stop:true})},complete:function(){e(window).unbind("unload",
function(){abortDataLoad()})}});this.dataDefer.push(b)},_clearOverlay:function(){this.deviceSet.attr({fill:"#999"})},_buildTimeControls:function(){var a;a=['<li class="time">','<a href="#play" class="play"><span>Play</span></a>','<a href="#pause" class="pause" style="display:none"><span>Pause</span></a>','<a href="#rewind" class="rewind"><span>Rewind</span></a>','<a href="#stepBackward" class="stepBackward"><span>Step Backward</span></a>','<a href="#stepForward" class="stepForward"><span>Step Forward</span></a>',
'<div class="timeSlider">','<span class="sliderHandle"></span>',"</div>",'<span class="timer">'+this._overlays[this._currentOverlay.type].data[0][0]+"</span>","</li>"];if(this.$element.find(".time").length)this.$element.find(".time");else{a=e(a.join(""));this.$element.find(".controls").append(a);a.find(".sliderHandle").css({left:0}).draggable({containment:"parent"})}if(this._currentOverlay.timeslice===0)for(a=0;a<this._overlays[this._currentOverlay.type].data.length;a++)if(this._overlays[this._currentOverlay.type].data[a][0].split(" ")[1]==
"12:00"){this._currentOverlay.timeslice=a;this._setPosition();return}this._setPosition()},_buildLegend:function(){this.$element.children(".content").append({faults:['<ul class="legend">','<li class="legendValue09">Fault</li>',"</ul>"],N:['<ul class="legend">','<li class="legendValue00">&gt; 95%</li>','<li class="legendValue01">90%-94%</li>','<li class="legendValue02">85%-89%</li>','<li class="legendValue03">80%-84%</li>','<li class="legendValue04">75%-79%</li>','<li class="legendValue05">50%-74%</li>',
'<li class="legendValue06">&lt; 50%</li>','<li class="legendValue07">0%</li>',"</ul>"],A:['<ul class="legend">','<li class="legendValue00">&gt; 80%</li>','<li class="legendValue01">60%-79%</li>','<li class="legendValue02">40%-59%</li>','<li class="legendValue03">20%-39%</li>','<li class="legendValue04">&lt; 20%</li>','<li class="legendValue07">0%</li>',"</ul>"],R:['<ul class="legend">','<li class="legendValue00">&gt; 40</li>','<li class="legendValue01">30-39</li>','<li class="legendValue02">20-29</li>',
'<li class="legendValue03">10-19</li>','<li class="legendValue03">&lt; 10</li>','<li class="legendValue07">0</li>',"</ul>"],E:['<ul class="legend baseline">','<li class="legendValue00">&gt; 120</li>','<li class="legendValue01">115-119</li>','<li class="legendValue02">110-114</li>','<li class="legendValue03">105-110</li>','<li class="legendValue04">103-104</li>','<li class="legendValue05">98-102</li>','<li class="legendValue06">95-97</li>','<li class="legendValue07">90-94</li>','<li class="legendValue08">85-89</li>',
'<li class="legendValue09">80-84</li>','<li class="legendValue10">75-79</li>','<li class="legendValue11">&lt; 74</li>',"</ul>"]}[this._currentOverlay.type].join(""))},_duration:function(){return this.$element.find("li.time .timeSlider").width()-this.$element.find(".timeSlider .sliderHandle").width()},_increment:function(){return this.$element.find(".timeSlider").width()/this._overlays[this._currentOverlay.type].data.length},_timerPosition:function(){return parseInt(this.$element.find(".sliderHandle").css("left"))},
_run:function(){var a=this;if(this._currentOverlay.playing==true&&this._timerPosition()<this._duration()-this._increment()){this._currentOverlay.timeslice=++this._currentOverlay.timeslice;this.$element.find(".timeSlider .sliderHandle").css({left:this._currentOverlay.timeslice*this._increment()});this._overlays[this._currentOverlay.type].data[this._currentOverlay.timeslice]&&this.$element.find(".time span.timer").text(this._overlays[this._currentOverlay.type].data[this._currentOverlay.timeslice][0]);
this._paintPanels();setTimeout(function(){a._run()},100)}else{this._timerPosition()>=this._duration()-this._increment()&&this.$element.find(".timeSlider .sliderHandle").css({left:this._duration()});this.$element.find("a.pause").hide();this.$element.find("a.play").show()}var d=this._overlays[this._currentOverlay.type].data[this._currentOverlay.timeslice][0].split(" "),b=d[0].split("-"),d=d[1].split(":"),b=Date.UTC(+b[0],+b[1]-1,+b[2],+d[0],+d[1]);e(document).trigger("mapPlay",{utcDate:b})},play:function(){this._timerPosition()>=
this._duration()&&this.rewind();this._currentOverlay.playing=true;this._run();this.$element.find("a.play").hide();this.$element.find("a.pause").show()},pause:function(){this._currentOverlay.playing=false;this.$element.find("a.pause").hide();this.$element.find("a.play").show()},_setPosition:function(){this.$element.find("li.time .sliderHandle").css({left:this._currentOverlay.timeslice*this._increment()});this.$element.find("li.time span.timer").text(this._overlays[this._currentOverlay.type].data[this._currentOverlay.timeslice][0]||
"n/a");this._paintPanels();this.$element.find("a.play").show();this.$element.find("a.pause").hide();var a=this._overlays[this._currentOverlay.type].data[this._currentOverlay.timeslice][0].split(" "),d=a[0].split("-"),a=a[1].split(":"),d=Date.UTC(+d[0],+d[1]-1,+d[2],+a[0],+a[1]);e(document).trigger("mapPlay",{utcDate:d})},rewind:function(){this._currentOverlay.playing=false;this._currentOverlay.timeslice=0;this._setPosition()},stepBackward:function(){this._currentOverlay.playing=false;if(this._currentOverlay.timeslice>
0){this._currentOverlay.timeslice=--this._currentOverlay.timeslice;this._setPosition()}},stepForward:function(){this._currentOverlay.playing=false;if(this._timerPosition()<this._duration()){this._currentOverlay.timeslice=++this._currentOverlay.timeslice;this._setPosition()}this._timerPosition()>=this._duration()-this._increment()&&this.$element.find(".timeSlider .sliderHandle").css({left:this._duration()})},_paintPanels:function(){var a=this._overlays[this._currentOverlay.type],d=this._currentOverlay.type,
b=this._currentOverlay.timeslice,f=this.deviceSet.length;if(this._currentOverlay.type==="faults"){if(a.data&&a.data.length)for(var c=0;c<f;c++){var e=this.deviceSet[c].data("myInfo");if(e.attached!==null&&e.attached!=="null"&&a.data&&a.data.length){d=0;for(b=a.data.length;d<b;d++){var i=a.data[d];(i.device_id===e.id||i.Node!==g.allNodesByType.SiteArray.id&&e.isChildOf(i.device_id))&&this.deviceSet[c].attr({fill:"#06c"})}}}}else if(a.data&&a.data.length)for(c=0;c<f;c++){e=this.deviceSet[c].data("myInfo");
if(e.attached!==null&&e.attached!=="null"){var e=e.id,i=a.data[b],h=+i[1][e];if(i&&i[1][e])if(d=="N")switch(true){case h>=95:this.deviceSet[c].attr({fill:"#034E7B"});break;case h>=90:this.deviceSet[c].attr({fill:"#0570B0"});break;case h>=85:this.deviceSet[c].attr({fill:"#3690C0"});break;case h>=80:this.deviceSet[c].attr({fill:"#74A9CF"});break;case h>=75:this.deviceSet[c].attr({fill:"#A6BDDB"});break;case h>=50:this.deviceSet[c].attr({fill:"#eeec2d"});break;case h>0:this.deviceSet[c].attr({fill:"#f12727"});
break;case h<=0:this.deviceSet[c].attr({fill:"#111"});break;default:this.deviceSet[c].attr({fill:"#999"})}else if(d=="E")switch(true){case h>=120:this.deviceSet[c].attr({fill:"#0080FF"});break;case h>=115:this.deviceSet[c].attr({fill:"#2E9AFE"});break;case h>=110:this.deviceSet[c].attr({fill:"#58ACFA"});break;case h>=105:this.deviceSet[c].attr({fill:"#8ABEF7"});break;case h>102:this.deviceSet[c].attr({fill:"#A9D0F5"});break;case h>=98:this.deviceSet[c].attr({fill:"#CEE3F6"});break;case h>=95:this.deviceSet[c].attr({fill:"#F6CECE"});
break;case h>=90:this.deviceSet[c].attr({fill:"#F5A9A9"});break;case h>=85:this.deviceSet[c].attr({fill:"#F78181"});break;case h>=80:this.deviceSet[c].attr({fill:"#FA5858"});break;case h>=75:this.deviceSet[c].attr({fill:"#FE2E2E"});break;case h<75:this.deviceSet[c].attr({fill:"#f12727"});break;default:this.deviceSet[c].attr({fill:"#999"})}else switch(true){case h>300:this.deviceSet[c].attr({fill:"#f12727"});break;case h>=40:this.deviceSet[c].attr({fill:"#034E7B"});break;case h>=30:this.deviceSet[c].attr({fill:"#0570B0"});
break;case h>=20:this.deviceSet[c].attr({fill:"#3690C0"});break;case h>=10:this.deviceSet[c].attr({fill:"#74A9CF"});break;case h>0:this.deviceSet[c].attr({fill:"#A6BDDB"});break;case h<=0:this.deviceSet[c].attr({fill:"#111"});break;default:this.deviceSet[c].attr({fill:"#999"})}else this.deviceSet[c].attr({fill:"#999"})}}else this._clearOverlay()},update:function(){this.dataDefer=[];if(this._currentOverlay.type!="faults")this._getOverlayData({type:this._currentOverlay.type});else{this._overlays.faults.data=
ss.issueData.faults;this._paintPanels()}},destroy:function(){this.$element.remove();this.$element.off();e(document).unbind(".maps."+this.options.id)},_addListeners:function(){var a=this;this.$element.find(".controls li.rotate a").click(function(b){b.preventDefault();e(this).attr("href")=="#rotate_left"?a.rotate({direction:"-",amount:15}):e(this).attr("href")=="#rotate_right"&&a.rotate({direction:"+",amount:15})});this.$element.find(".controls li.zoom a").click(function(b){b.preventDefault();e(this).attr("href")==
"#zoom_out"?a.zoom({direction:"-"}):e(this).attr("href")=="#zoom_in"&&a.zoom({direction:"+"})});this.$element.find(".controls li.reset a").click(function(b){b.preventDefault();a.resetPosition()});this.$element.find(".controls li.center a").click(function(b){b.preventDefault();a.center()});this.$element.delegate("div.nodeInfo a.close","click",function(b){b.preventDefault();a.destroyNodeInfo({duration:250})});this.$element.delegate("a.changeView","click",function(b){b.preventDefault();for(var b=e(this).attr("href").split("?")[1].split("&"),
f={},c=0,d=b.length;c<d;c++){var g=b[c].split("=");f[g[0]]=g[1]}e(this).hasClass("disabled")?ss.modules.create("popUps",{content:"There are too many "+f.deviceType.toLowerCase()+"s at that level for your browser to render.",id:"nodeDisplayLimitation",title:"Node Display Limitation",dynamic:true}):a.changeView(f)});this.$element.delegate("a.deviceNavigation","click",function(a){a.preventDefault();a.stopPropagation();e(document).trigger("setDevice",{deviceId:e(this).attr("href").replace("#","")})});
e(".arrayNavContainer").delegate("li","mouseover mouseout",function(b){b.preventDefault();b.stopPropagation();var f=this.id.split("_");b.type=="mouseover"?a.hilite({deviceId:f[1],deviceType:f[0]}):b.type=="mouseout"&&a.hilite()});this.$element.delegate("select.overlayType","change",function(){a._setOverlayType({type:e(this).val()});e(this).blur()});this.$element.delegate(".sliderHandle","drag",function(b,f){a._currentOverlay.timeslice=parseInt(a._overlays[a._currentOverlay.type].data.length/e(this).parent().width()*
f.position.left);var c=a._overlays[a._currentOverlay.type].data[a._currentOverlay.timeslice][0].split(" "),d=c[0].split("-"),c=c[1].split(":"),d=Date.UTC(+d[0],+d[1]-1,+d[2],+c[0],+c[1]);e(document).trigger("mapPlay",{utcDate:d});a._paintPanels();a._overlays[a._currentOverlay.type]&&a.$element.find("li.time span.timer").text(a._overlays[a._currentOverlay.type].data[a._currentOverlay.timeslice][0])});this.$element.find(".controls").delegate("a","click",function(b){b.preventDefault();e(this).hasClass("play")?
a.play():e(this).hasClass("pause")?a.pause():e(this).hasClass("rewind")?a.rewind():e(this).hasClass("stepBackward")?a.stepBackward():e(this).hasClass("stepForward")&&a.stepForward()});e(document).bind("updateModules.maps."+this.options.id,function(){a.update()});e(document).bind("setDevice.maps."+this.options.id,function(b,d){var c=g.allNodesById[d.deviceId].devtype==="SiteArray"?"Inverter":g.allNodesById[d.deviceId].devtype,e=g.allNodesById[d.deviceId].parent;a._selectedDevice=d.deviceId;a.options.nodeInfo&&
(g.allNodesById[d.deviceId].devtype!=="SiteArray"?a.nodeInfo({node:d.deviceId}):a.destroyNodeInfo());c!==a._currentDeviceType?a.changeView({deviceType:c,node:e}):a.options.hilite&&a.hilite()});e(document).bind("setTime.maps."+this.options.id,function(b,d){if(a._currentOverlay.type!=="faults")for(var c=new Date(roundNumber(d.time/3E5,0)*3E5),c=c.getUTCFullYear()+"-"+("0"+(c.getUTCMonth()+1)).slice(-2)+"-"+("0"+c.getUTCDate()).slice(-2)+" "+("0"+c.getUTCHours()).slice(-2)+":"+("0"+c.getUTCMinutes()).slice(-2),
e=0,g=a._overlays[a._currentOverlay.type].data.length;e<g;e++)if(a._overlays[a._currentOverlay.type].data[e][0]===c){a._currentOverlay.timeslice=e;a._setPosition()}});e(document).keydown(function(b){if(a._currentOverlay&&a._currentOverlay.type&&a._currentOverlay.type!="faults"){b.keyCode==39&&a.stepForward();b.keyCode==37&&a.stepBackward()}});this.$element.bind("click",function(a){a.stopPropagation();e(this).addClass("focus")});e(document).bind("click",function(){a.$element.removeClass("focus")});
this.$element.on("mousewheel",function(b,d){if(e(this).hasClass("focus")){b.preventDefault();d<=0?a.zoom({direction:"-"}):d>=0&&a.zoom({direction:"+"})}});this.options.addClass&&this.options.addClass==="mini"&&this.$element.hover(function(){e(this).find(".legend").fadeOut()},function(){e(this).find(".legend").fadeIn()});var d=function(){if(a.dataDefer)for(var b=0,d=a.dataDefer.length;b<d;b++)a.dataDefer[b].abort()};this.$element.find("select.overlayType").change(function(){d()});e(window).bind("unload.map."+
this.options.id,function(){d()})},_deviceLimit:function(a){return this.options.deviceCountLimit[a]?this.options.deviceCountLimit[a]:this.options.deviceCountLimit["default"]},_center_x:function(){return this.$element.find(".mapCanvas").outerWidth()/2},_center_y:function(){return this.$element.find(".mapCanvas").outerHeight()/2},_position:function(){return this.$element.find(".mapCanvas").position()},options:{title:"My Array Map",defaultRotation:0,northOffset:0,defaultZoom:1,overlays:true,controls:true,
nodeInfo:true,draggable:true,overlays:true,inverterStatus:false,hilite:true,startingDevice:false,deviceCountLimit:{String:1E3,"default":500}}}};return ss.maps.map});