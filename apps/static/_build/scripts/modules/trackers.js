/*
 Copyright 2013 Draker - Pats Pending
*/
define(["jquery","dataTables","static/_build/scripts/modules/dateBasic"],function(d){ss.trackers={myTrackers:[],template:function(b){return['<div id="'+b.id+'" class="module tracker">','<div class="testFilter">','<label for="min_date">Start Date:</label> <input id="min_date" name="min_date" type="text" value="'+d("input[name=latest_date]").val()+'" /> ','<label for="max_date">End Date:</label> <input id="max_date" name="max_date" type="text" value="'+d("input[name=latest_date]").val()+'" /><br>','<strong>Models</strong>: <label for="product_model_SPM80V12A"><input type="checkbox" name="product_model" id="product_model_SPM80V12A" value="SPM80V12A"> SPM80V12A</label> <label for="product_model_SPM80V12A-S"><input type="checkbox" name="product_model" id="product_model_SPM80V12A-S" value="SPM80V12A-S"> SPM80V12A-S</label> <label for="product_model_SPM125V8A"><input type="checkbox" name="product_model" id="product_model_SPM125V8A" value="SPM125V8A"> SPM125V8A</label> <label for="product_model_SPM125V8A-S"><input type="checkbox" name="product_model" id="product_model_SPM125V8A-S" value="SPM125V8A-S"> SPM125V8A-S</label> <label for="product_model_SPO350W80V"><input type="checkbox" name="product_model" id="product_model_SPO350W80V" value="SPO350W80V"> SPO350W80V</label><br><strong>Status</strong>: <label for="fail_only"><input type="checkbox" name="fail_only" id="fail_only" value="fail"> Show Failed Tests</label><br><div class="container_buttons"><a href="#filter" class="button primary filter">Update Data</a>',
'<img src='+ss.urls.src+'"../../../images/icon_loading.gif" class="loading">','</div></div><table class="basic monitorSummary"><thead><tr><th style="width: 390px" colspan="5">SPM Functional</th><th style="width: 390px" colspan="5">SPM Incoming</th><th style="width: 390px" colspan="5">SPM Final</th></tr><tr><th>Median Pass Time</th><th>Median Fail Time</th><th># Tested</th><th># Failed</th><th>Yield</th><th>Median Pass Time</th><th>Median Fail Time</th><th># Tested</th><th># Failed</th><th>Yield</th><th>Median Pass Time</th><th>Median Fail Time</th><th># Tested</th><th># Failed</th><th>Yield</th></tr></thead><tbody></tbody></table><table class="basic monitorSummary"><thead><tr><th style="width: 390px" colspan="5">SPO Functional</th><th style="width: 390px" colspan="5">SPO Incoming</th><th style="width: 390px" colspan="5">SPO Final</th></tr><tr><th>Median Pass Time</th><th>Median Fail Time</th><th># Tested</th><th># Failed</th><th>Yield</th><th>Median Pass Time</th><th>Median Fail Time</th><th># Tested</th><th># Failed</th><th>Yield</th><th>Median Pass Time</th><th>Median Fail Time</th><th># Tested</th><th># Failed</th><th>Yield</th></tr></thead><tbody></tbody></table><table class="basic tests sort"><thead><tr><th>Part ID</th><th style="width: 120px">MAC</th><th>Model</th><th style="width: 50px">Functional</th><th>Func. Overall</th><th style="width: 50px">Incoming</th><th>Inc. Overall</th><th style="width: 50px">Final</th><th>Fin. Overall</th><th>Test Start</th><th>Last Update</th></tr></thead><tbody></tbody></table></div>'].join("")},
tracker:{_init:function(b,c){this.options=d.extend({},this.options,b);this.$element=d(ss.trackers.template(this.options));this.element=this.$element[0];c?d(c).append(this.$element):d(".container_modules").append(this.$element);ss.dateBasic.init();this._addListeners();this._filter();d("table.sort").dataTable()},_filter:function(){this.$element.find("img.loading").hide();var b;b=d("input[name=product_model]");var c=[];d.each(b,function(){d(this).is(":checked")&&c.push(d(this).val())});b=c.join("+");
var a;a=d("input[name=fail_only]").is(":checked")?"fail":"";this._getData({startdate:this.$element.find("input#min_date").val(),enddate:this.$element.find("input#max_date").val(),product_model:b,status:a})},_getData:function(b){var c=this;d.ajax({url:"/api/summary?start_date="+b.startdate+"&end_date="+b.enddate+"&product_model="+b.product_model+"&status="+b.status,cache:!1,async:!0,success:function(a){var b=c.$element.find("table.sort");b.dataTable().fnClearTable(!1);c.testData_results=a.results;
c.testData_summary=a.summary;c._populate();c.$element.find("img.loading").hide();b.dataTable().fnDraw(!0);b.dataTable().fnSort([[7,"desc"],[6,"desc"]])},error:function(){ss.modules.create("messages",c.$element[0],{type:"error",content:"Data failed to load"});c.$element.find("img.loading").hide()}})},_populate:function(){var b=this.$element.find("table.monitorSummary > tbody"),c=this.$element.find("table.monitorSummary > tbody"),a=this.$element.find("table.tests > tbody");if(this.testData_results.length){myMonitorInfo=
["<tr>","<td>"+this.testData_summary.spmfunctionaltest.median_pass_time+"</td>","<td>"+this.testData_summary.spmfunctionaltest.median_fail_time+"</td>","<td>"+this.testData_summary.spmfunctionaltest.num_tested+"</td>","<td>"+this.testData_summary.spmfunctionaltest.num_failed+"</td>","<td>"+this.testData_summary.spmfunctionaltest.yield+"</td>","<td>"+this.testData_summary.spmincomingtest.median_pass_time+"</td>","<td>"+this.testData_summary.spmincomingtest.median_fail_time+"</td>","<td>"+this.testData_summary.spmincomingtest.num_tested+
"</td>","<td>"+this.testData_summary.spmincomingtest.num_failed+"</td>","<td>"+this.testData_summary.spmincomingtest.yield+"</td>","<td>"+this.testData_summary.spmfinaltest.median_pass_time+"</td>","<td>"+this.testData_summary.spmfinaltest.median_fail_time+"</td>","<td>"+this.testData_summary.spmfinaltest.num_tested+"</td>","<td>"+this.testData_summary.spmfinaltest.num_failed+"</td>","<td>"+this.testData_summary.spmfinaltest.yield+"</td>","</tr>"];myMonitorInfo=["<tr>","<td>"+this.testData_summary.spofunctionaltest.median_pass_time+
"</td>","<td>"+this.testData_summary.spofunctionaltest.median_fail_time+"</td>","<td>"+this.testData_summary.spofunctionaltest.num_tested+"</td>","<td>"+this.testData_summary.spofunctionaltest.num_failed+"</td>","<td>"+this.testData_summary.spofunctionaltest.yield+"</td>","<td>"+this.testData_summary.spoincomingtest.median_pass_time+"</td>","<td>"+this.testData_summary.spoincomingtest.median_fail_time+"</td>","<td>"+this.testData_summary.spoincomingtest.num_tested+"</td>","<td>"+this.testData_summary.spoincomingtest.num_failed+
"</td>","<td>"+this.testData_summary.spoincomingtest.yield+"</td>","<td>"+this.testData_summary.spofinaltest.median_pass_time+"</td>","<td>"+this.testData_summary.spofinaltest.median_fail_time+"</td>","<td>"+this.testData_summary.spofinaltest.num_tested+"</td>","<td>"+this.testData_summary.spofinaltest.num_failed+"</td>","<td>"+this.testData_summary.spofinaltest.yield+"</td>","</tr>"];b.append(myMonitorInfo.join(""));c.append(myMonitorInfo.join(""));myTestInfo=[];b=0;for(c=this.testData_results.length;b<
c;b++){var a=this.testData_results[b],e=null===a.functional_passed?"":!0===a.functional_passed?"PASS":"<b>FAIL</b>",f=null===a.incoming_passed?"":!0===a.incoming_passed?"PASS":"<b>FAIL</b>",g=null===a.final_passed?"":!0===a.final_passed?"PASS":"<b>FAIL</b>";1<a.functional_count&&(e+=" ("+a.functional_count+")");1<a.incoming_count&&(f+=" ("+a.incoming_count+")");1<a.final_count&&(g+=" ("+a.final_count+")");var h=null===a.functional_passed_overall?"":!0===a.functional_passed_overall?"PASS":"<b>FAIL</b>",
i=null===a.incoming_passed_overall?"":!0===a.incoming_passed_overall?"PASS":"<b>FAIL</b>",j=null===a.final_passed_overall?"":!0===a.final_passed_overall?"PASS":"<b>FAIL</b>";myTestInfoRow=['<a href="/detail/'+a.part_id+"?start_date="+this.$element.find("input#min_date").val()+"&end_date="+this.$element.find("input#min_date").val()+'">'+a.part_id+"</a>",a.mac_id,a.product_model,e,h,f,i,g,j,a.start_date,a.end_date];myTestInfo.push(myTestInfoRow)}d("table.sort").dataTable().fnAddData(myTestInfo)}else b.append('<tr><td colspan="12">No summary data found for selected time range</td></tr>'),
c.append('<tr><td colspan="12">No summary data found for selected time range</td></tr>'),a.append('<tr><td colspan="8">No test data found for selected time range</td></tr>')},_addListeners:function(){var b=this;this.$element.find("a.filter").click(function(c){c.preventDefault();b.$element.find("tbody > tr").remove();b._filter()})},options:{sort:"end_date",sort_up:!1}}};return ss.trackers.tracker});