/*
 Copyright 2013 Draker - Pats Pending
*/
define(["jquery","static/_build/scripts/modules/urls","hovers","utils"],function(b){ss.statusWidgets={template:function(){return'<div class="module statusWidget">;<div class="content">;<div class="energyHistory">;<table class="basic">;<thead>;<tr>;<th>Energy</th>;<th>Today</th>;<th>Week to Date</th>;<th>Month to Date</th>;<th>Year to Date</th>;</tr>;</thead>;<tbody>;<tr class="ac">;<td class="label"><span>AC</span></td>;<td><span class="value_ac today">0</span> <span class="unit">kWh</span></td>;<td><span class="value_ac week">0</span> <span class="unit">kWh</span></td>;<td><span class="value_ac month">0</span> <span class="unit">MWh</span></td>;<td><span class="value_ac year">0</span> <span class="unit">MWh</span></td>;</tr>;<tr class="dc">;<td class="label"><span>DC</span></td>;<td><span class="value today">0</span> <span class="unit">kWh</span></td>;<td><span class="value week">0</span> <span class="unit">kWh</span></td>;<td><span class="value month">0</span> <span class="unit">MWh</span></td>;<td><span class="value year">0</span> <span class="unit">MWh</span></td>;</tr>;</tbody>;</table>;</div>;<h3>Performance Ratio <span>(<a href="#description?position=right&width=300" class="link_hover" title="<p>The performance ratio is a measure of the quality of a PV plant based on actual AC energy generation compared to its theoretical potential.</p><p>AC data is <strong>required</strong> for this calculation.</p>">What\'s this?</a>)</span>;</h3>;<div class="status performanceRatio">;<div class="floatWrapper">;<div class="indicatorWrapper">;<div class="indicatorContainer">;<div class="indicator"></div>;</div>;</div>;</div>;<div class="number"><span>0%</span></div>;</div>;<h3>Soiling <span>(<a href="#description?position=right&width=300" class="link_hover" title="<p>Soiling measurements represent the likely impact of contaminants and other debris based on what we know about your array\'s efficiency</p>">What\'s this?</a>)</span>;</h3>;<div class="status efficiency">;<div class="floatWrapper">;<div class="indicatorWrapper">;<div class="indicatorContainer">;<div class="indicator"></div>;</div>;<div class="legend">;<div class="warning"><span>Warning</span></div>;<div class="alert"><span>Alert</span></div>;</div>;</div>;</div>;<div class="number"><span>0%</span> Power Loss</div>;</div>;<h3>Health <span>(<a href="#description?position=right&width=300" class="link_hover" title="<p>Health describes the combined impact of known array hardware issues</p>">What\'s this?</a>)</span>;</h3>;<div class="status health">;<div class="floatWrapper">;<div class="indicatorWrapper">;<div class="indicatorContainer">;<div class="indicator"></div>;</div>;<div class="legend">;<div class="warning"><span>Warning</span></div>;<div class="alert"><span>Alert</span></div>;</div>;</div>;</div>;<div class="number"><span>0%</span> Power Loss</div>;</div>;</div>;</div>'.split(";")},
statusWidget:{_init:function(a,c){this.options=b.extend({},this.options,a);this.$element=b(ss.statusWidgets.template(a).join(""));this.element=this.$element[0];this.$element.data("module",this);c?b(c).append(this.$element):b(".container_modules").append(this.$element);b.each(this.$element.find(".link_hover"),function(){ss.modules.create("hovers",{position:"right",width:300,content:b(this).attr("title"),attachTo:this});b(this).removeAttr("title")});this._energyHistory();this._run();this._addListeners()},
_energyHistory:function(){var a=this;b.ajax({url:ss.urls.energyHistory,cache:!1,async:!0,success:function(c){var d=b(".energyHistory");a.hasDCData=null===c.commissioned_to_date?!1:!0;a.hasACData=null===c.ac_commissioned_to_date?!1:!0;a.myToday=c.today/1E3;a.myWeek=c.week_to_date/1E3;a.myMonth=c.month_to_date/1E6;a.myYear=c.year_to_date/1E6;a.myToday_ac=c.ac_today/1E3;a.myWeek_ac=c.ac_week_to_date/1E3;a.myMonth_ac=c.ac_month_to_date/1E6;a.myYear_ac=c.ac_year_to_date/1E6;d.find("span.value.today").text(roundNumber(a.myToday,
1));d.find("span.value.week").text(roundNumber(a.myWeek,1));d.find("span.value.month").text(roundNumber(a.myMonth,2));d.find("span.value.year").text(roundNumber(a.myYear,2));a.hasACData?(d.find("span.value_ac.today").text(roundNumber(a.myToday_ac,1)),d.find("span.value_ac.week").text(roundNumber(a.myWeek_ac,1)),d.find("span.value_ac.month").text(roundNumber(a.myMonth_ac,2)),d.find("span.value_ac.year").text(roundNumber(a.myYear_ac,2))):d.find("tr.ac").addClass("disabled");b(".module.resources").length&&
a.resources()}})},resources:function(){var a=["oil","trees","water"],c=["Gallons of oil","Trees","Gallons of H20"],d=[roundNumber(27.3*this.myYear,0),roundNumber(3.75*this.myYear,0),roundNumber(230*this.myYear,0)],e=0,f=function(){b(".module.resources").find(".icon").removeClass(a[e]);e===a.length-1?e=0:e++;var f=999<d[e]?roundNumber(d[e]/1E3,1)+"K":d[e];b(".module.resources").find(".icon").addClass(a[e]);b(".module.resources").find(".number").text(f);b(".module.resources").find(".resource").text(c[e])};
f();setInterval(f,15E3)},_run:function(){b.ajax({url:ss.urls.status,cache:!1,success:function(a){var c=null===a.perf_ratio||"null"===a.perf_ratio?100:Math.round(a.perf_ratio),d=null===a.cleanliness||"null"===a.cleanliness?100:Math.round(a.cleanliness),e=a.cleanlinessWarning,f=a.cleanlinessProblem,k=null===a.health||"null"===a.health?100:Math.round(a.health),i=a.healthWarning,l=a.healthProblem,j=b(".status.performanceRatio"),g=b(".status.efficiency"),h=b(".status.health");a.perf_ratio?(j.find(".indicator").animate({width:100<
c?"100%":c+"%"}),j.find(".number span").text(c+"%")):(j.addClass("disabled"),j.find(".number span").text("n/a"));a.cleanliness&&(g.find(".indicator").animate({width:100<d?"100%":d+"%"}),g.find(".number span").text(100-d+"%"),0<e?(100-a.cleanliness>f?g.find(".indicator").addClass("alert"):100-a.cleanliness>e&&g.find(".indicator").addClass("warning"),g.find(".legend .warning").css({width:f-e+"%","margin-right":e+"%"})):g.find(".legend div").hide());a.health&&(h.find(".indicator").animate({width:100<
k?"100%":k+"%"}),h.find(".number span").text(100-k+"%"),0<i?(100-a.health>l?h.find(".indicator").addClass("alert"):100-a.health>i&&h.find(".indicator").addClass("warning"),h.find(".legend .warning").css({width:l-i+"%","margin-right":i+"%"})):h.find(".legend div").hide())}})},update:function(){this._energyHistory()},_addListeners:function(){var a=this;b(document).bind("updateModules.statusWidgets",function(){a.update()})}}};return ss.statusWidgets.statusWidget});