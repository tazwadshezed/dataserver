define(["jquery","jquery-helpers","static/_build/scripts/modules/devices"],function(d, j, f){ss.deviceSelectors={deviceSelector:{_init:function(a){this.options=d.extend({},this.options,a);this.element=this.options.attachTo;this.$element=d(this.options.attachTo);var b=this;f.dataDefer.done(function(){b._populateDictionary();b._build();b._addListeners()})},_populateDictionary:function(){this._deviceDictionary=[];this._deviceDictionary.push({displayName:"Environment",label:"env",id:"env",type:"env",keywords:"environment temperature irradiance"});
for(var a=1,b=f.nodeTypes.length;a<b;a++){device=0;for(devicesLength=f.allNodesByType[f.nodeTypes[a]].length;device<devicesLength;device++){var c=f.allNodesByType[f.nodeTypes[a]][device],e=c.devtype+" - ",d="";if(c.parentNodes){var h=void 0;for(h in c.parentNodes)"SiteArray"!==h&&(d=d+c.parentNodes[h][1]+" &raquo; ")}e={displayName:e+d+"<strong>"+c.label+"</strong>",label:c.label,id:c.id,type:c.devtype,keywords:" "+c.devtype+" "+c.label+" "+c.id};if(c.parentNodes){var c=c.parentNodes,g;for(g in c)e.keywords=
e.keywords+" "+c[g][0]+" ",e.keywords=e.keywords+" "+c[g][1]+" "}this._deviceDictionary.push(e)}}},_build:function(){if(d(".deviceSelectorList").length)this.myDropDown=d(".deviceSelectorList");else{for(var a=['<div id="'+this.options.id+'_deviceSelectorList" class="deviceSelectorList" style="display:none;">',"<ul>"],b=0,c=this._deviceDictionary.length;b<c;b++)a.push('<li id="'+this.options.id+"_deviceSelectorItem_"+b+'" class="deviceSelectorItem_'+b+'"><a href="#'+this._deviceDictionary[b].id+'" class="deviceSelectorItem">'+
this._deviceDictionary[b].displayName+"</a></li>");a.push("</ul></div>");this.myDropDown=d(a.join(""));d("body").append(this.myDropDown)}},appendDevice:function(a){this._deviceDictionary.push(a);this.myDropDown.find("ul").prepend('<li id="'+this.options.id+"_deviceSelectorItem_"+(this._deviceDictionary.length-1)+'" class="deviceSelectorItem_'+(this._deviceDictionary.length-1)+'"><a href="#'+a.id+'" class="deviceSelectorItem">'+a.displayName+"</a></li>")},_position:function(){var a=this.$element.offset();
this.myDropDown.css({width:this.options.width||this.$element.width(),"max-height":Math.min(this.options.height,d(window).height()-a.top-this.$element.outerHeight()-12),top:this.$element.outerHeight()+a.top,left:a.left})},show:function(){this._position();this.myDropDown.show();this.isVisible=!0},hide:function(){this.myDropDown.hide();this.isVisible=!1},filter:function(a){for(var b=0,c=this._deviceDictionary.length;b<c;b++)if(this._deviceDictionary[b].keywords){for(var e=this._deviceDictionary[b].keywords.toLowerCase(),
d=a.toLowerCase().split(" "),f=0,g=0,i=d.length;g<i;g++)0<=e.indexOf(d[g])&&f++;f===d.length?document.getElementById(this.options.id+"_deviceSelectorItem_"+b).style.display="":document.getElementById(this.options.id+"_deviceSelectorItem_"+b).style.display="none"}},destroy:function(){this.$element.remove();this.myDropDown.off();this.$element.find("input.facade").off();this.$element.find("input.value").off()},_addListeners:function(){var a=this,b=this.$element.find("input.facade"),c=this.$element.find("input.value");
d(window).smartresize(function(){a._position()});this.$element.click(function(a){a.stopPropagation()});b.click(function(){this.isVisible||a.show()});b.focus(function(){a.show()});this.myDropDown.click(function(a){a.stopPropagation()});d("body").click(function(){a.hide()});this.myDropDown.delegate("a.deviceSelectorItem","click",function(e){e.preventDefault();a.isVisible&&(e=f.allNodesById[d(this).attr("href").replace("#","")],c.val(d(this).attr("href").replace("#","")),b.val(e?e.label:d(this).text()),
a.options.afterSelect(),a.hide())});b.keyup(function(){var b=d(this).val();c.val("");a._filterTimeout&&clearTimeout(a._filterTimeout);a._filterTimeout=setTimeout(function(){a.filter(b)},300)})},options:{height:300,width:240,afterSelect:function(){}}}};return ss.deviceSelectors.deviceSelector});