/*
 Copyright 2013 Draker - Pats Pending
*/
define(["jquery"],function(a){"ontouchstart"in document.documentElement&&(a("div.page_nav").bind("touchstart",function(){a(this).addClass("pageNavHover")}),a("div.page_nav").bind("touchend",function(){a(this).removeClass("pageNavHover")}));ss.app={_init:function(){require(["layoutHelpers","devices","moduleFactory"],function(){a(document).ready(function(){a(".fullHeight").length&&ss.layouts.find();if(a("body#page_dashboard").length||a("#deviceDetail").length){ss.modules.create("arrayNav",document.getElementById("arrayNavContainer"));
ss.modules.create("breadcrumbs",document.getElementById("breadcrumbs"));a(document).bind("setDevice",function(a,b){ss.changeTemplate(b.deviceId)});ss.devices.dataDefer.done(function(){window.location.hash&&window.location.hash.replace("#","")?a(document).trigger("setDevice",{deviceId:window.location.hash.replace("#","")}):a(document).trigger("setDevice",{deviceId:ss.devices.allNodesByType.SiteArray.id})});a(document).bind("setDevice",function(a,b){window.location.hash=b.deviceId})}a("a.link_popUp").length&&
ss.popUps.find();ss.automation._init()})})}};ss.automation={_init:function(){var a=this;require(["dates"],function(){a.run();a._addListeners()})},run:function(){var e=function(){a(document).trigger("updateModules")};var b=new Date,b=Date.UTC(b.getFullYear(),b.getMonth(),b.getDate()),c=ss.dates.max("utc")||b;c&&b==c?this.updateInterval=setInterval(e,3E5):clearInterval(this.updateInterval)},_addListeners:function(){var e=this;a(document).bind("setDate",function(){e.run()})}};ss.changeTemplate=function(e){var b=
{SiteArray_default:[{type:"maps",title:"Array Map",size:"full",overlay:"relativePower",defaultRotation:"",northOffset:""},{type:"charts",title:"Power and Irradiance",size:"full",deviceType:"env+arraycalc",deviceID:"env+{{node}}",dataType:"irradiance_mean+P",chartType:"spline"},{type:"charts",title:"Inverters Power",size:"full",deviceType:"invcalc",deviceID:"{{node}}",dataType:"P",chartType:"spline"},{type:"issues",title:"All Faults",size:"full",issue_type:"faults"}],Inverter_default:[{type:"maps",
title:"Array Map",size:"full",overlay:"relativePower",defaultRotation:"",northOffset:""},{type:"charts",title:"Power and Irradiance",size:"half",deviceType:ss.devices.allData.sitearray.inverter_metering?"env+invcalc+"+ss.devices.allData.sitearray.inverter_metering:"env+invcalc",deviceID:ss.devices.allData.sitearray.inverter_metering?"env+{{node}}+{{node}}":"env+{{node}}",dataType:ss.devices.allData.sitearray.inverter_metering?"irradiance_mean+P+Pi-Po":"irradiance_mean+P",chartType:"spline"},{type:"charts",
title:"Current and Voltage",size:"half",deviceType:"invcalc",deviceID:"{{node}}",dataType:"I-V",chartType:"spline"},{type:"charts",addClass:"multi",title:"Strings Power",size:"full",deviceType:"strcalc",deviceID:"{{node}}",dataType:"P",chartType:"spline"},{type:"issues",title:"Faults",size:"full",issue_type:"faults",node:"{{node}}"}],Inverter_withCombiners:[{type:"maps",title:"Array Map",size:"full",overlay:"relativePower",defaultRotation:"",northOffset:""},{type:"charts",title:"Power and Irradiance",
size:"half",deviceType:"env+invcalc",deviceID:"env+{{node}}",dataType:"irradiance_mean+P",chartType:"spline"},{type:"charts",title:"Current and Voltage",size:"half",deviceType:"invcalc",deviceID:"{{node}}",dataType:"I-V",chartType:"spline"},{type:"charts",addClass:"multi",title:"Combiners Power",size:"full",deviceType:"comcalc",deviceID:"{{node}}",dataType:"P",chartType:"spline"},{type:"issues",title:"Faults",size:"full",issue_type:"faults",node:"{{node}}"}],InverterCombiner_default:[{type:"maps",
title:"Array Map",size:"full",overlay:"relativePower",defaultRotation:"",northOffset:""},{type:"charts",title:"Power and Irradiance",size:"half",deviceType:"env+invcalc",deviceID:"env+{{node}}",dataType:"irradiance_mean+P",chartType:"spline"},{type:"charts",title:"Current and Voltage",size:"half",deviceType:"invcalc",deviceID:"{{node}}",dataType:"I-V",chartType:"spline"},{type:"charts",addClass:"multi",title:"Combiners Power",size:"full",deviceType:"comcalc",deviceID:"{{node}}",dataType:"P",chartType:"spline"},
{type:"issues",title:"Faults",size:"full",issue_type:"faults",node:"{{node}}"}],Combiner_default:[{type:"maps",title:"Array Map",size:"full",overlay:"relativePower",defaultRotation:"",northOffset:""},{type:"charts",title:"Power and Irradiance",size:"half",deviceType:"env+comcalc",deviceID:"env+{{node}}",dataType:"irradiance_mean+P",chartType:"spline"},{type:"charts",title:"Current and Voltage",size:"half",deviceType:"comcalc",deviceID:"{{node}}",dataType:"I-V",chartType:"spline"},{type:"charts",addClass:"multi",
title:"Strings Power",size:"full",deviceType:"strcalc",deviceID:"{{node}}",dataType:"P",chartType:"spline"},{type:"issues",title:"Faults",size:"full",issue_type:"faults",node:"{{node}}"}],Recombiner_default:[{type:"maps",title:"Array Map",size:"full",overlay:"relativePower",defaultRotation:"",northOffset:""},{type:"charts",title:"Power and Irradiance",size:"half",deviceType:"env+rcomcalc",deviceID:"env+{{node}}",dataType:"irradiance_mean+P",chartType:"spline"},{type:"charts",title:"Current and Voltage",
size:"half",deviceType:"rcomcalc",deviceID:"{{node}}",dataType:"I-V",chartType:"spline"},{type:"charts",addClass:"multi",title:"Combiners Power",size:"full",deviceType:"comcalc",deviceID:"{{node}}",dataType:"P",chartType:"spline"},{type:"issues",title:"Faults",size:"full",issue_type:"faults",node:"{{node}}"}],String_default:[{type:"maps",title:"Array Map",size:"full",overlay:"relativePower",defaultRotation:"",northOffset:""},{type:"charts",title:"Power and Irradiance",size:"half",deviceType:"env+strcalc",
deviceID:"env+{{node}}",dataType:"irradiance_mean+P",chartType:"spline"},{type:"charts",title:"Current and Voltage",size:"half",deviceType:"strcalc",deviceID:"{{node}}",dataType:ss.user.role==="S"?"I-V-V_prime":"I-V",chartType:"spline"},{type:"charts",addClass:"multi",title:"Panels Power",size:"full",deviceType:"opt+invcalc",deviceID:"{{node}}+{{Inverter}}",dataType:"Po_mean+Po_mean",chartType:"spline"},{type:"charts",addClass:"multi",title:"Panels Voltage",size:"full",deviceType:"opt+invcalc",deviceID:"{{node}}+{{Inverter}}",
dataType:"Vo_mean+Vo_mean",chartType:"spline"},{type:"issues",title:"Faults",size:"full",issue_type:"faults",node:"{{node}}"}],Panel_default:[{type:"maps",title:"Array Map",size:"full",overlay:"relativePower",defaultRotation:"",northOffset:""},{type:"charts",title:"Irradiance and Power",size:"half",deviceType:"invcalc+env+opt",deviceID:"{{Inverter}}+env+{{node}}",dataType:"Po_mean+irradiance_mean+Po_mean",chartType:"spline"},{type:"charts",title:"Voltage and Current",size:"half",deviceType:"invcalc+opt",
deviceID:"{{Inverter}}+{{node}}",dataType:"Vo_mean-Io_mean+Vo_mean-Io_mean",chartType:"spline"},{type:"issues",title:"Faults",size:"full",issue_type:"faults",node:"{{node}}"}]},e=ss.devices.allNodesById[e],c=e.devtype,j=a(".container_modules"),c=c==="Inverter"&&ss.devices.allNodesByType.Inverter[0].inputs[0].devtype==="Combiner"?c.replace(" ","_")+"_withCombiners":c.replace(" ","_")+"_default";a(".module").length&&a.each(a(".module"),function(){if(!a(this).hasClass("map")){var b=a(this).data("module"),
c=a(this).closest(".container");b.destroy();c.remove()}});var f;a:{if(b[c]){f=0;for(var h=b[c].length;f<h;f++)if(b[c][f].type==="maps"){f=true;break a}}f=void 0}if(f===false)a(".module.map").hide();else if(a(".module.map").length)a(".module.map").show();else{j.append('<div id="container_arrayMap" class="container fullWidth" />');ss.modules.create("maps",document.getElementById("container_arrayMap"),{size:"full"})}if(b[c]){f=0;for(h=b[c].length;f<h;f++){var d=b[c][f];if(d.type!=="maps"){var i=Math.floor(Math.random()*
65536).toString(16),k=a('<div id="container_'+i+'" class="container '+d.size+'Width" />');j.append(k);for(var g in d){d[g]=d[g].replace(/{{node}}/g,e.id);d[g]=d[g].replace(/{{parent}}/g,e.parent);e.parentNodes&&e.parentNodes.Inverter&&(d[g]=d[g].replace(/{{Inverter}}/g,e.parentNodes.Inverter[0]))}d.id=d.type+"_"+i;ss.modules.create(d.type,document.getElementById("container_"+i),d)}}}};return ss.app});