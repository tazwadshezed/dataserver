define(["jquery"],function(b){ss.chartBuilder={lines:0,line:{_init:function(){var a=this;ss.chartBuilder.lines++;this.lineNumber=ss.chartBuilder.lines;var e=b(['<div id="lineDefinition_'+this.lineNumber+'" class="lineDefinition">','<a href="#removeLine" class="removeLine">Remove Line</a>',"<h4>Line "+this.lineNumber+"</h4>",'<div id="deviceSelector_'+this.lineNumber+'" class="deviceSelector">','<input id="selectDevice_'+this.lineNumber+'" name="selectDevice" class="facade" type="text" placeholder="Start typing to add device">',
'<input id="selectDevice_'+this.lineNumber+'_id" name="selectDevice" class="value" type="hidden">',"</div>",'<select id="Data_'+this.lineNumber+'" name="Data_'+this.lineNumber+'" class="selectData" disabled>','<option value="">- Select Data Type -</option></select></div>'].join(""));this.$element=e;b("form#chartBuilder > div.container_buttons").before(e);ss.modules.create("deviceSelectors",{afterSelect:function(){var b=a.$element.find("select"),d="env"===a.$element.find(".deviceSelector .value").val()?
!0:!1,e=['<option value="">- Select Data Type -</option>','<option value="irradiance_mean">Irradiance</option>','<option value="panel_temperature_mean">Panel Temp</option>','<option value="ambient_temperature_mean">Ambient Temp</option>'],f=['<option value="">- Select Data Type -</option>','<option value="Pi_mean">Power</option>','<option value="Ii_mean">Current</option>','<option value="Vi_mean">Voltage</option>'];"S"===ss.user.role&&(f='<option value="">- Select Data Type -</option>;<option value="Pi_mean">Power In</option>;<option value="Po_mean">Power Out</option>;<option value="Pi_stdev">Power (stdev)</option>;<option value="Pi_min">Power (min)</option>;<option value="Pi_max">Power (max)</option>;<option value="Ii_mean">Current In</option>;<option value="Io_mean">Current Out</option>;<option value="Ii_stdev">Current (stdev)</option>;<option value="Ii_min">Current (min)</option>;<option value="Ii_max">Current (max)</option>;<option value="Vi_mean">Voltage In</option>;<option value="Vo_mean">Voltage Out</option>;<option value="Vi_stdev">Voltage (stdev)</option>;<option value="Vi_min">Voltage (min)</option>;<option value="Vi_max">Voltage (max)</option>'.split(";"));
d?b.html(e.join("")):b.html(f.join(""));b.removeAttr("disabled")},id:"deviceSelector_"+a.lineNumber,attachTo:b("#deviceSelector_"+this.lineNumber).get()})}},chartTemplate:function(a){return{type:"chart",title:"Custom Chart",deviceType:a.deviceType,deviceID:a.deviceID,dataType:a.dataType,chartType:"spline",addClass:"fullHeight"}},buildChart:function(){var a={};b(".lineDefinition").each(function(e){var c=b(this).find("input.value").val(),d=b(this).find("select.selectData option:selected").val(),g=function(){if("env"===
c)return"env";switch(c.charAt(0)){case "P":return"opt";case "S":return"strcalc";case "I":return"invcalc";default:return"opt"}},f=function(){return"env"===c?d:"Panel"===ss.devices.allNodesById[c].devtype?d:d.charAt(0)};c&&d?(b(this).closest(".lineDefinition").find(".message").remove(),0<e?(a.deviceID=a.deviceID+"+"+c,a.deviceType=a.deviceType+"+"+g(),a.dataType=a.dataType+"+"+f()):(a.deviceID=c,a.deviceType=g(),a.dataType=f())):c?d||ss.errorMessages({element:b(this).closest(".lineDefinition"),type:"error",
content:"No data type selected",fixed:!0}):ss.errorMessages({element:b(this).closest(".lineDefinition"),type:"error",content:"No device selected",fixed:!0})});a.deviceID&&ss.modules.create("charts",ss.chartBuilder.chartTemplate(a))},_addListeners:function(){b("form#chartBuilder").submit(function(a){a.preventDefault();b(".module.chart").length&&b(".module.chart").data("module").destroy();ss.chartBuilder.buildChart()});b("div.chartBuilder_controls").delegate("a.addLine","click",function(a){a.preventDefault();
ss.chartBuilder.addLine()});b("div.chartBuilder_controls").delegate("a.removeLine","click",function(a){a.preventDefault();b(this).closest("div.lineDefinition").remove()})},addLine:function(){Object.create(this.line)._init()},_init:function(){require(["layoutHelpers","devices"],function(){b(document).ready(function(){b(".fullHeight").length&&ss.layouts.find();b(".chartBuilder_controls").find("img.loading").hide();ss.chartBuilder.addLine();ss.chartBuilder._addListeners()})})}}});